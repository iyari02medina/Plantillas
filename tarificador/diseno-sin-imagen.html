<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotización de Servicios - Gestión Hidráulica</title>

    <!-- Fuentes (Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <!-- Botón Flotante -->
    <div class="print-btn-container">
        <button onclick="window.print()" class="btn-print">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            Imprimir / PDF
        </button>
    </div>

    <!-- Contenedor Principal (Hoja) -->
    <div class="page-container">

        <!-- Barra Superior -->
        <div class="top-bar"></div>

        <div class="content-wrapper">

            <!-- Encabezado -->
            <header>
                <div class="logo-box">
                    <img style="margin-bottom: .5rem;" src="../logo-cophi-negro.jpg" alt="Logo Cophi">
                    <p style="font-weight: 500; font-size: 11px; margin-bottom: .5rem;">CONTROL DE
                        PROCESOS<br>HIDRAULICOS S.A. DE C.V.
                    </p>

                </div>

                <div class="header-info">
                    <h1 style="font-size: 14px;">ANÁLISIS DE LABORATORIO TARIFICADO</h1>
                    <p class="subtitle" style="overflow-wrap: break-word;">{{ nombre_cliente }}</p>
                    <div class="meta-data">
                        <div>Folio: <span style="font-weight: 600;">{{ folio_tar }}</span></div>
                        <div>Fecha emisión: <span style="font-weight: 600;">{{ fecha_tar }}</span></div>

                    </div>
                </div>
            </header>

            <!-- Sección Cliente -->
            <section class="client-card">

                <div class="client-grid">
                    <div>
                        <p class="label">Empresa: </p>
                        <p class="value-lg">{{ nombre_cliente }}</p>
                        <p class="value-text">{{ direccion_cliente }}</p>
                    </div>
                    <div class="client-right-col">
                        <div style="margin-bottom: 0.5rem;">
                            <p class="label">no. permiso de descargas</p>
                            <p class="value-md">{{ no_permiso }}</p>
                        </div>
                        <div>
                            <p class="label">vigencia del permiso</p>
                            <p class="value-text">{{ vigencia_permiso }}</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Detalles del Servicio -->
            <main class="main-section">
                <h3 style="font-weight: 600;">INFORME DE RESULTADOS DE ANALISIS DE LABORATORIO</h3>

            </main>
            <div class="volumen-container">
                <div>
                    <p class="label" style="margin-bottom: 0;">VOLUMEN PROMEDIO DESCARGADO (m³): </p>

                </div>
                <div class="value-text" style="padding-right: 1rem;">{{ volumen_promedio }} m³</div>
            </div>

            <!-- Tabla de Costos -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40%;">PARÁMETRO</th>
                            <th style="width: 18%;">RESULTADO</th>
                            <th class="center" style="width: 18%;">LMP</th>
                            <th class="center" style="width: 24%;">PRECIO m³.</th>
                        </tr>
                    </thead>
                    <tbody>

                        <tr>
                            <td>
                                <span class="item-title">{{ item.nombre_item }}</span>
                            </td>
                            <td>
                                <span class="item-desc">
                                    {{ item.descripcion_item }}
                                </span>
                            </td>
                            <td style="font-size: 11px;" class="td-center">{{ item.unidad_item }}</td>
                            <td style="font-size: 11px;" class="td-bold-center">{{ item.cantidad_item }}</td>

                        </tr>
                        <tr>
                            <td><span class="item-title">SÓLIDOS SUSPENDIDOS TOTALES</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">DEMANDA BIOQUÍMICA DE OXÍGENO</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">GRASA Y ACEITES</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">SÓLIDOS SEDIMENTABLES</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">MATERIA FLOTANTE</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">TEMPERATURA</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">SUSTANCIA ACTIVAS AL AZUL DE METILENO</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">DEMANDA QUÍMICA DE OXÍGENO</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">NITROGENO TOTAL</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">FENOLES</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>
                        <tr>
                            <td><span class="item-title">COLOR</span></td>
                            <td></td>
                            <td style="font-size: 11px;" class="td-center"></td>
                            <td style="font-size: 11px;" class="td-bold-center"></td>
                        </tr>

                    </tbody>
                </table>
            </div>

            <!-- Resumen Financiero -->
            <div class="financial-summary">
                <div class="summary-box">
                    <div class="summary-row">
                        <span class="font-medium">Subtotal</span>
                        <span>$ {{ subtotal }}MXN</span>
                    </div>
                    <div class="summary-row">
                        <span class="font-medium">IVA (16%)MXN</span>
                        <span>$ {{ iva }}MXN</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">TOTAL MXN</span>
                        <span class="total-amount">$ {{ total }}MXN</span>
                    </div>
                </div>
            </div>
            <div class="financial-summary" style="justify-content: flex-start; padding: 1rem 1rem;">
                <div class="legal-text">
                    <p>Terminos y Condiciones</p>
                    <p>{{ terminos }}</p>
                </div>
            </div>
            <div class="financial-summary">
                <div class="signature-area">
                    <div class="signature-line"></div>
                    <p class="signer-name">{{ gestor }}</p>
                    <p class="signer-role">{{ puesto_gestor }}</p>
                </div>
            </div>

            <!-- Footer -->
            <footer>
                <div class="footer-content">
                </div>

                <div style=" height: .25rem; background-color: var(--brand-600); width: 100%; margin-top: 1rem;">
                </div>
                <div style="display: flex; justify-content: space-between;" class="bottom-bar">
                    <div style="font-weight: 600; font-size: 11px; padding: 1rem; ">CONTROL DE PROCESOS
                        HIDRAULICOS S.A.
                        DE C.V.</div>
                    <div style="font-weight: 600; font-size: 11px; padding: 1rem; "> (222)-889-4469</div>
                    <div style="font-weight: 600; font-size: 11px; padding: 1rem; ">ejecutivo@cophi.mx</div>
                </div>
            </footer>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                // Capitalizar primera letra del mes
                const dateStr = today.toLocaleDateString('es-MX', options);
                dateElement.textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
            }

            // Ejecutar Paginación con un retraso para asegurar carga de estilos
            setTimeout(paginateContent, 1000);
        });

        function paginateContent() {
            // console.log("Iniciando paginación...");
            const firstPage = document.querySelector('.page-container');
            if (!firstPage) return;

            checkPageOverflow(firstPage, 1);
        }

        function checkPageOverflow(page, pageNum) {
            if (!pageNum) pageNum = 1;

            // Safety limit
            if (pageNum > 20) {
                console.warn("Límite de páginas alcanzado.");
                return;
            }

            // console.log(`Verificando desbordamiento en página ${pageNum}...`);
            const contentWrapper = page.querySelector('.content-wrapper');
            const footer = page.querySelector('footer');
            if (!contentWrapper || !footer) return;

            // Constantes para tamaño Carta (27.94cm a 96dpi ~= 1056px)
            const PAGE_HEIGHT_PX = 1056;

            // Altura real ocupada por el footer + márgenes seguros
            const footerHeight = footer.offsetHeight || 150;

            // El límite donde el contenido DEBE detenerse
            // Footer está posicionado 'bottom: 1rem' (relative to page)
            // Entonces footer top ~= PAGE_HEIGHT_PX - footerHeight - 16 (1rem)
            // Damos un buffer extra de 30px
            const limit = PAGE_HEIGHT_PX - footerHeight - 16 - 30 - 180;

            // console.log(`Límite de corte calculado: ${limit}px`);

            // Obtener elementos de contenido
            // IMPORTANT: Excluir explícitamente el footer de esta lista para no moverlo
            const children = Array.from(contentWrapper.children).filter(el => el !== footer && el.tagName !== 'SCRIPT');
            const pageRect = page.getBoundingClientRect();

            for (let i = 0; i < children.length; i++) {
                const child = children[i];
                // Ignorar elementos de estructura fijos
                if (child.classList.contains('top-bar') || child.tagName === 'HEADER') continue;

                // getBoundingClientRect es relativo al viewport. Restamos pageRect.top para tener 'top' relativo a la página.
                const childRect = child.getBoundingClientRect();
                const relativeBottom = childRect.bottom - pageRect.top;

                // CASO 1: Tabla (puede dividirse)
                if (child.classList.contains('table-container')) {
                    const table = child.querySelector('table');
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));

                    // Revisar cada fila
                    for (let r = 0; r < rows.length; r++) {
                        const row = rows[r];
                        const rowRect = row.getBoundingClientRect();
                        const rowRelativeBottom = rowRect.bottom - pageRect.top;

                        if (rowRelativeBottom > limit) {
                            // console.log(`Desbordamiento detectado en fila ${r} de la tabla. Creando página ${pageNum + 1}`);
                            const newPage = createNewPageFrom(page);

                            // Mover filas restantes
                            const remainingRows = rows.slice(r);
                            moveTableRowsToPage(remainingRows, newPage, child);

                            // Mover elementos siguientes (totales, legales, etc.)
                            const remainingSiblings = children.slice(i + 1);
                            moveSiblingsToPage(remainingSiblings, newPage);

                            // Verificar recursivamente la nueva página
                            setTimeout(() => checkPageOverflow(newPage, pageNum + 1), 100);
                            return;
                        }
                    }
                }
                // CASO 2: Bloques Normales (Totales, Notas, etc.)
                else {
                    if (relativeBottom > limit) {
                        // console.log(`Desbordamiento detectado en bloque ${child.className}. Creando página ${pageNum + 1}`);
                        const newPage = createNewPageFrom(page);

                        // Mover este bloque y todos los siguientes
                        const remainingElements = children.slice(i);
                        moveSiblingsToPage(remainingElements, newPage);

                        setTimeout(() => checkPageOverflow(newPage, pageNum + 1), 100);
                        return;
                    }
                }
            }
            // console.log(`Página ${pageNum} verificada, sin más desbordamientos.`);
        }

        function createNewPageFrom(originalPage) {
            const newPage = originalPage.cloneNode(true);
            const contentWrapper = newPage.querySelector('.content-wrapper');

            // Limpiar contenido principal para recibir solo lo movido
            // Mantenemos Header y Footer intactos
            const contentSelectors = ['.client-card', '.main-section', '.table-container', '.financial-summary'];
            contentSelectors.forEach(sel => {
                const els = contentWrapper.querySelectorAll(sel);
                els.forEach(e => e.remove());
            });

            document.body.appendChild(newPage);
            return newPage;
        }

        function moveTableRowsToPage(rows, targetPage, originalTableContainer) {
            const contentWrapper = targetPage.querySelector('.content-wrapper');
            const footer = contentWrapper.querySelector('footer');

            // Crear wrapper de tabla si no existe
            let targetTableContainer = contentWrapper.querySelector('.table-container');
            if (!targetTableContainer) {
                targetTableContainer = originalTableContainer.cloneNode(true);
                // Limpiar tbody
                targetTableContainer.querySelector('tbody').innerHTML = '';
                // Insertar ANTES del footer
                contentWrapper.insertBefore(targetTableContainer, footer);
            }

            const tbody = targetTableContainer.querySelector('tbody');
            rows.forEach(row => tbody.appendChild(row));
        }

        function moveSiblingsToPage(elements, targetPage) {
            const contentWrapper = targetPage.querySelector('.content-wrapper');
            const footer = contentWrapper.querySelector('footer');

            elements.forEach(el => {
                // Verificar que sea un nodo elemento y no el footer ni script
                if (el.nodeType === 1 && el.tagName !== 'SCRIPT' && el !== footer) {
                    contentWrapper.insertBefore(el, footer);
                }
            });
        }
    </script>
</body>

</html>