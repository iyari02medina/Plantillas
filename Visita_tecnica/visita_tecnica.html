<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orden de Trabajo</title>

    <!-- Fuentes (Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="estilos.css">
</head>

<body>

    <!-- Bot칩n Flotante -->
    <div class="print-btn-container">
        <button onclick="window.print()" class="btn-print">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            Imprimir / PDF
        </button>
    </div>

    <!-- Contenedor Principal (Hoja) -->
    <div class="page-container">

        <!-- Barra Superior -->
        <div class="top-bar"></div>

        <div class="content-wrapper">

            <!-- Encabezado -->
            <header>
                <div class="logo-section">
                    <img src="../logo-cophi-negro.jpg" alt="Logo Cophi">
                    <p>CONTROL DE PROCESOS<br>HIDRAULICOS S.A. DE C.V.
                    </p>
                </div>

                <div class="header-info">
                    <h1>Diagn칩stico de Visita T칠cnica</h1>
                    <p class="subtitle" style="overflow-wrap: break-word;">{{ nombre_cliente }}</p>
                    <div class="meta-data">
                        <div>Folio: <span style="font-weight: 600;">{{ folio_ot }}</span></div>
                        <div>Fecha: <span style="font-weight: 600;">{{ fecha_ot }}</span></div>
                    </div>
                </div>
            </header>

            <!-- Secci칩n Cliente -->
            <section class="client-card">

                <div class="client-grid">
                    <div>
                        <p class="label">Empresa: </p>
                        <p class="value-lg">{{ nombre_cliente }}</p>
                        <p class="value-text">{{ direccion_cliente }}</p>
                    </div>
                    <div class="client-right-col">
                        <div style="margin-bottom: 0.75rem;">
                            <p class="label">Atenci칩n a</p>
                            <p class="value-md">{{ nombre_contacto }}</p>
                        </div>
                        <div>
                            <p class="label">Contacto</p>
                            <p class="value-text">{{ telefono_contacto }}</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 1. Inventario de Equipos Principales -->
            <div class="form-section force-break">
                <div class="section-title-bar">
                    <span class="section-header-text">1. Inventario de Equipos Principales (Registro de Activos)</span>
                </div>

                <span class="form-subtitle">Almacenamiento y Suministro</span>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cisterna</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" style="flex: 0.3;" value="No: {{ inv_cisterna_no }}"
                                placeholder="No.">
                            <input type="text" class="form-input" value="Capacidad: {{ inv_cisterna_cap }}"
                                placeholder="Capacidad">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tinaco(s)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" style="flex: 0.3;" value="No: {{ inv_tinacos_no }}"
                                placeholder="No.">
                            <input type="text" class="form-input" value="Capacidad: {{ inv_tinacos_cap }}"
                                placeholder="Capacidad Unit.">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Medidor de Agua</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" value="Serie: {{ inv_medidor_serie }}"
                                placeholder="No. Serie">
                            <input type="text" class="form-input" value="Lectura: {{ inv_medidor_lectura }}"
                                placeholder="Lectura Actual">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pipas de Agua</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" style="flex: 0.4;" value="Si/No: {{ inv_pipas_sn }}"
                                placeholder="Si/No">
                            <input type="text" class="form-input" value="m3 mensual: {{ inv_pipas_m3 }}"
                                placeholder="m3 mensual">
                        </div>
                    </div>
                </div>

                <span class="form-subtitle">Equipos de Bombeo y Red</span>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Sistema de Bombeo</label>
                        <input type="text" class="form-input" value="Datos: {{ inv_bombas }}"
                            placeholder="Ej. 2 Bombas 3HP Evans">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tanque Hidroneum치tico</label>
                        <input type="text" class="form-input" value="Datos: {{ inv_tanque_hidro }}"
                            placeholder="Ej. 80L / 40-60 PSI">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tomas Conectadas</label>
                        <input type="text" class="form-input" value="No: {{ inv_tomas_no }}" placeholder="No.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Registros</label>
                        <input type="text" class="form-input" value="No: {{ inv_registro_no }}" placeholder="No.">
                    </div>
                    <div class="form-group" style="flex: 1.5;">
                        <label class="form-label">Trampa de Grasa</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" style="flex: 0.3;" value="No: {{ inv_trampas_no }}"
                                placeholder="No.">
                            <input type="text" class="form-input" value="Capacidad: {{ inv_trampas_cap }}"
                                placeholder="Capacidad">
                        </div>
                    </div>
                </div>

                <span class="form-subtitle">Muebles Sanitarios y Eficiencia</span>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">WC</label>
                        <input type="text" class="form-input" value="No: {{ inv_wc_no }}" placeholder="Cant.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lavamanos</label>
                        <input type="text" class="form-input" value="No: {{ inv_lavamanos_no }}" placeholder="Cant.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fregaderos</label>
                        <input type="text" class="form-input" value="No: {{ inv_fregaderos_no }}" placeholder="Cant.">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Mecanismos para ahorro de agua</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" style="flex: 0.2;" value="Si/No: {{ inv_ahorro_sn }}"
                                placeholder="Si/No">
                            <input type="text" class="form-input" value="Detalle: {{ inv_ahorro_lista }}"
                                placeholder="쯈u칠 mecanismos utiliza?">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Matriz de Inspecci칩n Detallada -->
            <div class="table-container">
                <div class="section-title-bar">
                    <span class="section-header-text">2. Matriz de Inspecci칩n Detallada</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Componente / 츼rea</th>
                            <th>Estado</th>
                            <th>Hallazgos y Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cisterna</td>
                            <td class="td-center">{{ st_cisterna }}</td>
                            <td>{{ obs_cisterna }}</td>
                        </tr>
                        <tr>
                            <td>Tinaco(s)</td>
                            <td class="td-center">{{ st_tinacos }}</td>
                            <td>{{ obs_tinacos }}</td>
                        </tr>
                        <tr>
                            <td>Tomas conectadas</td>
                            <td class="td-center">{{ st_tomas }}</td>
                            <td>{{ obs_tomas }}</td>
                        </tr>
                        <tr>
                            <td>Registro</td>
                            <td class="td-center">{{ st_registro }}</td>
                            <td>{{ obs_registro }}</td>
                        </tr>
                        <tr>
                            <td>Trampas de grasa</td>
                            <td class="td-center">{{ st_trampas }}</td>
                            <td>{{ obs_trampas }}</td>
                        </tr>
                        <tr>
                            <td>V치lvulas</td>
                            <td class="td-center">{{ st_valvulas }}</td>
                            <td>{{ obs_valvulas }}</td>
                        </tr>
                        <tr>
                            <td>Bombas</td>
                            <td class="td-center">{{ st_bombas }}</td>
                            <td>{{ obs_bombas }}</td>
                        </tr>
                        <tr>
                            <td>Tuber칤as</td>
                            <td class="td-center">{{ st_tuberias }}</td>
                            <td>{{ obs_tuberias }}</td>
                        </tr>
                        <tr>
                            <td>Grifer칤a</td>
                            <td class="td-center">{{ st_griferia }}</td>
                            <td>{{ obs_griferia }}</td>
                        </tr>
                        <tr>
                            <td>Medidores de agua</td>
                            <td class="td-center">{{ st_medidores }}</td>
                            <td>{{ obs_medidores }}</td>
                        </tr>
                        <tr>
                            <td>Fregadero</td>
                            <td class="td-center">{{ st_fregadero }}</td>
                            <td>{{ obs_fregadero }}</td>
                        </tr>
                        <tr>
                            <td>C칠spol</td>
                            <td class="td-center">{{ st_cespol }}</td>
                            <td>{{ obs_cespol }}</td>
                        </tr>
                        <tr>
                            <td>Coladeras y Rejillas</td>
                            <td class="td-center">{{ st_coladeras }}</td>
                            <td>{{ obs_coladeras }}</td>
                        </tr>
                        <tr>
                            <td>Bajadas Pluviales</td>
                            <td class="td-center">{{ st_pluviales }}</td>
                            <td>{{ obs_pluviales }}</td>
                        </tr>
                        <tr>
                            <td>WC</td>
                            <td class="td-center">{{ st_wc }}</td>
                            <td>{{ obs_wc }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 3. Evidencia Fotogr치fica y Hallazgos -->
            <div class="form-section">
                <div class="section-title-bar">
                    <span class="section-header-text">3. Evidencia Fotogr치fica</span>
                </div>
                <div class="photo-grid">
                    <div class="photo-placeholder">
                        <span class="photo-icon">游닞</span>
                        <span>Evidencia 01</span>
                        <div class="image-caption">{{ obs_evidencia_01 }}</div>
                    </div>
                    <div class="photo-placeholder">
                        <span class="photo-icon">游닞</span>
                        <span>Evidencia 02</span>
                        <div class="image-caption">{{ obs_evidencia_02 }}</div>
                    </div>
                    <div class="photo-placeholder">
                        <span class="photo-icon">游닞</span>
                        <span>Evidencia 03</span>
                        <div class="image-caption">{{ obs_evidencia_03 }}</div>
                    </div>
                    <div class="photo-placeholder">
                        <span class="photo-icon">游닞</span>
                        <span>Evidencia 04</span>
                        <div class="image-caption">{{ obs_evidencia_04 }}</div>
                    </div>
                </div>

            </div>
            <div class="form-section">
                <div class="section-title-bar">
                    <span class="section-header-text">4. Comentarios adicionales</span>
                </div>
                <div class="form-group mt-4">
                    <label class="form-label">Comentarios:</label>
                    <textarea class="form-input" rows="3">{{ hallazgos_comentarios }}</textarea>
                </div>
            </div>

            <!-- Firmas -->
            <footer>
                <div class="page-counter">P치gina <span class="page-val">1</span>-<span class="total-pages">1</span>
                </div>
                <div class="footer-line">
                </div>
                <div class="footer-content">
                    <div>CONTROL DE PROCESOS
                        HIDRAULICOS S.A.
                        DE C.V.</div>
                    <div>(222)-889-4469</div>
                    <div>ejecutivo@cophi.mx</div>
                </div>
            </footer>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                // Capitalizar primera letra del mes
                const dateStr = today.toLocaleDateString('es-MX', options);
                dateElement.textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
            }

            // Ejecutar Paginaci칩n con un retraso para asegurar carga de estilos
            setTimeout(paginateContent, 1000);
        });

        async function paginateContent() {
            // console.log("Iniciando paginaci칩n...");
            const firstPage = document.querySelector('.page-container');
            if (!firstPage) return;

            await checkPageOverflow(firstPage, 1);

            // Una vez finalizada la paginaci칩n, actualizar todos los totales
            const totalPages = document.querySelectorAll('.page-container').length;
            document.querySelectorAll('.total-pages').forEach(el => {
                el.textContent = totalPages;
            });
        }

        async function checkPageOverflow(page, pageNum) {
            if (!pageNum) pageNum = 1;

            // Safety limit
            if (pageNum > 20) {
                console.warn("L칤mite de p치ginas alcanzado.");
                return;
            }

            // console.log(`Verificando desbordamiento en p치gina ${pageNum}...`);
            const contentWrapper = page.querySelector('.content-wrapper');
            const footer = page.querySelector('footer');
            if (!contentWrapper || !footer) return;

            // Constantes para tama침o Carta (27.94cm a 96dpi ~= 1056px)
            const PAGE_HEIGHT_PX = 1056;

            // Altura real ocupada por el footer
            const footerHeight = footer.offsetHeight || 150;

            // El l칤mite donde el contenido DEBE detenerse
            // Footer est치 posicionado 'bottom: 1rem' (16px) desde el borde inferior
            // Calculamos el l칤mite m치s ajustado para aprovechar todo el espacio disponible
            // Dejamos un buffer de 80px para evitar solapamientos y tener buen espaciado
            // Verificar si hay imagenes en esta p치gina
            const hasImages = contentWrapper.querySelector('.images-column img');

            // Si hay im치genes, usamos el margen ajustado que pidi칩 el usuario (-5 -10)
            // Si no, usamos un margen est치ndar m치s seguro (-16 -20)
            const buffer = hasImages ? 15 : 36;
            const limit = PAGE_HEIGHT_PX - footerHeight - buffer;

            // console.log(`L칤mite de corte calculado: ${limit}px`);

            // Obtener elementos de contenido
            // IMPORTANT: Excluir expl칤citamente el footer de esta lista para no moverlo
            const children = Array.from(contentWrapper.children).filter(el => el !== footer && el.tagName !== 'SCRIPT');
            const pageRect = page.getBoundingClientRect();

            for (let i = 0; i < children.length; i++) {
                const child = children[i];
                // Ignorar elementos de estructura fijos
                if (child.classList.contains('top-bar') || child.tagName === 'HEADER') continue;

                // getBoundingClientRect es relativo al viewport. Restamos pageRect.top para tener 'top' relativo a la p치gina.
                const childRect = child.getBoundingClientRect();
                const relativeBottom = childRect.bottom - pageRect.top;

                // CASO 0: Salto de p치gina forzado (Petici칩n usuario)
                if (child.classList.contains('force-break')) {
                    console.log("Salto de p치gina forzado detectado.");
                    const nextSiblings = children.slice(i + 1);
                    if (nextSiblings.length > 0) {
                        const newPage = createNewPageFrom(page);
                        const nextNum = pageNum + 1;
                        const pageVal = newPage.querySelector('.page-val');
                        if (pageVal) pageVal.textContent = nextNum;

                        moveSiblingsToPage(nextSiblings, newPage);
                        await checkPageOverflow(newPage, pageNum + 1);
                        return;
                    }
                }

                // CASO 1: Tabla (puede dividirse)
                if (child.classList.contains('table-container')) {
                    const table = child.querySelector('table');
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));

                    // Revisar cada fila
                    for (let r = 0; r < rows.length; r++) {
                        const row = rows[r];
                        const rowRect = row.getBoundingClientRect();
                        const rowRelativeBottom = rowRect.bottom - pageRect.top;

                        if (rowRelativeBottom > limit) {
                            console.log(`Desbordamiento detectado en fila ${r} de ${rows.length}. Creando p치gina ${pageNum + 1}`);

                            // Si es la PRIMERA fila la que no cabe:
                            // 1. Si NO estamos al principio de la p치gina (i > 0), movemos la TABLA ENTERA a una nueva p치gina para probar suerte.
                            if (r === 0 && i > 0) {
                                console.log('La primera fila no cabe y no estamos al inicio. Moviendo tabla completa a la siguiente p치gina.');
                                const newPage = createNewPageFrom(page);
                                const nextNum = pageNum + 1;
                                const pageVal = newPage.querySelector('.page-val');
                                if (pageVal) pageVal.textContent = nextNum;

                                const elementsToMove = children.slice(i);
                                moveSiblingsToPage(elementsToMove, newPage);
                                await checkPageOverflow(newPage, pageNum + 1);
                                return;
                            }

                            // 2. Si r > 0, O si estamos al principio (i==0) y la fila 0 es enorme:
                            // Dividimos la tabla.
                            // Si r=0 y i=0, forzamos dejar la fila 0 aqu칤 para evitar bucle infinito de mover la tabla entera eternamente.
                            let splitIndex = r;
                            if (r === 0 && i === 0) {
                                console.warn('Fila 0 desborda al inicio de p치gina. Forzando corte en fila 1.');
                                splitIndex = 1;
                                // Si solo hay 1 fila y es enorme, no movemos nada (dejamos que desborde) para no crear p치gina vac칤a
                                if (splitIndex >= rows.length) return;
                            }

                            const newPage = createNewPageFrom(page);
                            const nextNum = pageNum + 1;
                            const pageVal = newPage.querySelector('.page-val');
                            if (pageVal) pageVal.textContent = nextNum;

                            // PASO 3: Mover filas restantes
                            const remainingRows = rows.slice(splitIndex);
                            console.log(`Moviendo ${remainingRows.length} filas restantes`);
                            moveTableRowsToPage(remainingRows, newPage, child);

                            // PASO 4: Mover TODO el contenido que sigue a esta tabla
                            // (Incluyendo otras tablas, grupo financiero, etc.)
                            const nextSiblings = children.slice(i + 1);
                            if (nextSiblings.length > 0) {
                                console.log(`Moviendo ${nextSiblings.length} elementos hermanos siguientes a la nueva p치gina.`);
                                moveSiblingsToPage(nextSiblings, newPage);
                            }

                            // Verificar recursivamente la nueva p치gina
                            await checkPageOverflow(newPage, pageNum + 1);
                            return;
                        }
                    }
                }
                // CASO 1.5: Im치genes (puede dividirse)
                else if (child.classList.contains('images-column')) {
                    const wrappers = Array.from(child.children);
                    for (let w = 0; w < wrappers.length; w++) {
                        const wrapper = wrappers[w];
                        const rect = wrapper.getBoundingClientRect();
                        const bottom = rect.bottom - pageRect.top;

                        if (bottom > limit) {
                            console.log(`Desbordamiento de imagen ${w}.`);

                            // Determinar si es el primer elemento significativo de la p치gina
                            const startOfContent = children.findIndex(c => !c.classList.contains('top-bar') && c.tagName !== 'HEADER');
                            const isAtTop = (i === startOfContent);

                            // Si es la primera imagen y no estamos al inicio, movemos todo el bloque
                            if (w === 0 && !isAtTop) {
                                console.log('Moviendo columna de im치genes completa');
                                const newPage = createNewPageFrom(page);
                                const nextNum = pageNum + 1;
                                const pageVal = newPage.querySelector('.page-val');
                                if (pageVal) pageVal.textContent = nextNum;

                                const elementsToMove = children.slice(i);
                                moveSiblingsToPage(elementsToMove, newPage);
                                await checkPageOverflow(newPage, pageNum + 1);
                                return;
                            }

                            // Si es la primera imagen y ESTAMOS al inicio, forzamos dividir en la siguiente
                            // Nota: Si solo hay 1 imagen y es gigante, w=0, isAtTop=true -> split=1. 1 >= length -> return.
                            // Esto evita bucle infinito para im치genes gigantes.
                            const splitIndex = (w === 0 && isAtTop) ? 1 : w;

                            if (splitIndex >= wrappers.length) {
                                console.warn("Imagen gigante al inicio no se puede dividir m치s.");
                                return;
                            }

                            console.log(`Dividiendo columna de im치genes en 칤ndice ${splitIndex}`);
                            const newPage = createNewPageFrom(page);
                            const nextNum = pageNum + 1;
                            const pageVal = newPage.querySelector('.page-val');
                            if (pageVal) pageVal.textContent = nextNum;

                            // 1. Crear nueva columna de im치genes en la nueva p치gina
                            const contentWrapper = newPage.querySelector('.content-wrapper');
                            const footer = contentWrapper.querySelector('footer');

                            // Clonar contenedor vac칤o
                            const newImagesColumn = child.cloneNode(false); // false = no clonar hijos deep
                            contentWrapper.insertBefore(newImagesColumn, footer);

                            // 2. Mover wrappers restantes
                            const remainingWrappers = wrappers.slice(splitIndex);
                            remainingWrappers.forEach(r => newImagesColumn.appendChild(r));

                            // 3. Mover hermanos siguientes
                            const nextSiblings = children.slice(i + 1);
                            if (nextSiblings.length > 0) {
                                moveSiblingsToPage(nextSiblings, newPage);
                            }

                            await checkPageOverflow(newPage, pageNum + 1);
                            return;
                        }
                    }
                }
                // CASO 1.7: Form Section (Petici칩n usuario: Evitar tocar el footer dividiendo el bloque)
                else if (child.classList.contains('form-section')) {
                    const formElements = Array.from(child.children).filter(el => !el.classList.contains('section-title-bar'));
                    for (let e = 0; e < formElements.length; e++) {
                        const element = formElements[e];
                        const rect = element.getBoundingClientRect();
                        const bottom = rect.bottom - pageRect.top;

                        if (bottom > limit) {
                            console.log(`Desbordamiento en form-section, elemento ${e}.`);
                            const isAtTop = (i === children.findIndex(c => !c.classList.contains('top-bar') && c.tagName !== 'HEADER'));

                            if (e === 0 && !isAtTop) {
                                const newPage = createNewPageFrom(page);
                                const nextNum = pageNum + 1;
                                const pageVal = newPage.querySelector('.page-val');
                                if (pageVal) pageVal.textContent = nextNum;
                                moveSiblingsToPage(children.slice(i), newPage);
                                await checkPageOverflow(newPage, pageNum + 1);
                                return;
                            }

                            const splitIndex = (e === 0 && isAtTop) ? 1 : e;
                            if (splitIndex >= formElements.length) continue;

                            const newPage = createNewPageFrom(page);
                            const nextNum = pageNum + 1;
                            const pageVal = newPage.querySelector('.page-val');
                            if (pageVal) pageVal.textContent = nextNum;

                            const contentWrapper = newPage.querySelector('.content-wrapper');
                            const footer = contentWrapper.querySelector('footer');

                            const newFormSection = child.cloneNode(true);
                            Array.from(newFormSection.children).forEach(nc => {
                                if (nc.classList.contains('section-title-bar')) {
                                    nc.querySelector('.section-header-text').textContent += " (Cont.)";
                                } else {
                                    nc.remove();
                                }
                            });

                            contentWrapper.insertBefore(newFormSection, footer);
                            formElements.slice(splitIndex).forEach(em => newFormSection.appendChild(em));
                            moveSiblingsToPage(children.slice(i + 1), newPage);

                            await checkPageOverflow(newPage, pageNum + 1);
                            return;
                        }
                    }
                }
                // CASO 2: Bloques Normales (Totales, Notas, etc.)
                else {
                    if (relativeBottom > limit) {
                        // PREVENCI칍N DE BUCLE: Si este es el primer elemento real de la p치gina,
                        // no lo movemos m치s, de lo contrario crear칤a p치ginas infinitas.
                        const firstRealChildIndex = children.findIndex(c =>
                            !c.classList.contains('top-bar') &&
                            c.tagName !== 'HEADER' &&
                            c.tagName !== 'SCRIPT'
                        );

                        if (i === firstRealChildIndex) {
                            console.warn("El elemento es demasiado grande para una sola p치gina. Deteniendo movimiento para evitar bucle.");
                            return;
                        }

                        console.log(`Desbordamiento detectado en bloque. Creando p치gina ${pageNum + 1}`);
                        const newPage = createNewPageFrom(page);
                        const nextNum = pageNum + 1;
                        const pageVal = newPage.querySelector('.page-val');
                        if (pageVal) pageVal.textContent = nextNum;

                        // Mover este bloque y todos los siguientes a la nueva p치gina
                        let elementsToMove = children.slice(i);
                        moveSiblingsToPage(elementsToMove, newPage);

                        // Verificar recursivamente la nueva p치gina
                        await checkPageOverflow(newPage, pageNum + 1);
                        return;
                    }
                }
            }
            // console.log(`P치gina ${pageNum} verificada, sin m치s desbordamientos.`);
        }

        function createNewPageFrom(originalPage) {
            const newPage = originalPage.cloneNode(true);
            const contentWrapper = newPage.querySelector('.content-wrapper');

            // Limpiar contenido principal para recibir solo lo movido
            // Mantenemos Header y Footer intactos
            const contentSelectors = ['.client-card', '.main-section', '.table-container', '.financial-summary', '.financial-group', '.images-column', '.table-container-alcance-table', '.form-section', '.closing-section']; // ADDED form-section and closing-section
            contentSelectors.forEach(sel => {
                const els = contentWrapper.querySelectorAll(sel);
                els.forEach(e => e.remove());
            });

            document.body.appendChild(newPage);
            return newPage;
        }

        function moveTableRowsToPage(rows, targetPage, originalTableContainer) {
            const contentWrapper = targetPage.querySelector('.content-wrapper');
            const footer = contentWrapper.querySelector('footer');

            // Crear wrapper de tabla si no existe
            let targetTableContainer = contentWrapper.querySelector('.table-container');
            if (!targetTableContainer) {
                targetTableContainer = originalTableContainer.cloneNode(true);
                // Limpiar tbody
                targetTableContainer.querySelector('tbody').innerHTML = '';
                // Insertar ANTES del footer
                contentWrapper.insertBefore(targetTableContainer, footer);
            }

            const tbody = targetTableContainer.querySelector('tbody');
            rows.forEach(row => tbody.appendChild(row));
        }

        function moveSiblingsToPage(elements, targetPage) {
            const contentWrapper = targetPage.querySelector('.content-wrapper');
            const footer = contentWrapper.querySelector('footer');

            elements.forEach(el => {
                // Verificar que sea un nodo elemento y no el footer ni script
                if (el.nodeType === 1 && el.tagName !== 'SCRIPT' && el !== footer) {
                    contentWrapper.insertBefore(el, footer);
                }
            });
        }
    </script>
</body>

</html>