{% extends 'base_flyonui.html' %}

{% block title %}{{ 'Detalle Tarificador' if tarificador and not is_new else 'Nuevo Tarificador' }} - Sistema Cophi{%
endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
    <div>
        <div class="flex items-center gap-2 mb-1">
            <a href="{{ url_for('tarificador') }}" class="btn btn-sm btn-ghost btn-circle" title="Volver">
                <span class="icon-[tabler--arrow-left] size-5"></span>
            </a>
            <h1 class="text-3xl font-bold text-base-content">{{ 'Detalle Tarificador' if tarificador and not is_new else
                'Nuevo
                Tarificador' }}</h1>
        </div>
        <p class="text-base-content/60 font-medium ml-10">
            {{ 'Consulta y edita los detalles de análisis de laboratorio.' if tarificador and not is_new else 'Complete
            el formulario
            para registrar un registro de tarificación.' }}
        </p>
    </div>
    {% if tarificador and not is_new %}
    <div class="flex gap-2">
        <a href="{{ url_for('ver_tarificador', folio=tarificador.folio_tar) }}" target="_blank"
            class="btn btn-soft btn-secondary">
            <span class="icon-[tabler--file-text] size-5"></span>
            Ver PDF
        </a>
        <button type="button" class="btn btn-primary shadow-sm" onclick="enableEdit()" id="btn-editar">
            <span class="icon-[tabler--edit] size-5"></span>
            Editar
        </button>
    </div>
    {% endif %}
</div>

<form action="{{ url_for('nuevo_tarificador') }}" method="POST" class="space-y-8 pb-20">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Columna Izquierda: Datos Generales -->
        <div class="mb-4">
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">

                <div class="card-body p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Folio</label>
                            <input type="text" id="folio_tar" name="folio_tar" placeholder="TAR-MMYY-###"
                                class="input input-bordered w-full font-bold text-primary always-locked"
                                value="{{ suggested_folio if not tarificador or is_new else tarificador.folio_tar }}"
                                required readonly {% if tarificador and not is_new %}disabled{% endif %}>
                        </div>
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Fecha
                                de
                                Creación</label>
                            <input type="text" id="fecha_tar" name="fecha_tar"
                                class="input input-bordered w-full always-locked"
                                value="{{ tarificador.fecha_tar if tarificador and not is_new else todays_date }}"
                                readonly {% if tarificador and not is_new %}disabled{% endif %}>
                        </div>
                    </div>

                </div>
            </div>

            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--user] size-5 text-secondary"></span>
                    <span>Datos del Cliente</span>
                </div>
                <div class="card-body p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control relative space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Cliente /
                                Empresa</label>
                            <div class="relative">
                                <input type="text" id="nombre_cliente" name="nombre_cliente" placeholder="Buscar..."
                                    autocomplete="off" class="input input-bordered w-full" oninput="fillClient(this)"
                                    required value="{{ tarificador.nombre_cliente if tarificador else '' }}" {% if
                                    tarificador %}disabled{% endif %}>
                                <div id="suggestions-box"
                                    class="absolute z-50 w-full mt-1 bg-base-100 border border-base-content/10 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden">
                                </div>
                            </div>
                        </div>
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">No.
                                Cliente</label>
                            <input type="text" id="no_cliente" name="no_cliente" class="input input-bordered w-full"
                                value="{{ tarificador.no_cliente if tarificador else '' }}" {% if tarificador
                                %}disabled{% endif %}>
                        </div>

                    </div>
                    <div class="form-control space-y-2">
                        <label
                            class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Dirección</label>
                        <textarea id="direccion_cliente" name="direccion_cliente"
                            class="textarea textarea-bordered w-full" rows="2" {% if tarificador %}disabled{% endif
                            %}>{{ tarificador.direccion_cliente if tarificador else '' }}</textarea>
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--key] size-5 text-primary"></span>
                    <span>Permisos Relacionados</span>
                </div>
                <div class="card-body p-6 flex flex-col gap-4">
                    <div class="form-control space-y-2">
                        <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">No.
                            Permiso
                            Descargas</label>
                        <input type="text" id="no_permiso_descargas" name="no_permiso_descargas"
                            class="input input-bordered w-full"
                            value="{{ tarificador.no_permiso_descargas if tarificador else '' }}" {% if tarificador
                            %}disabled{% endif %}>
                    </div>
                    <div class="form-control space-y-2">
                        <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Vigencia
                            Permiso</label>
                        <input type="text" id="vigencia_permiso_descargas" name="vigencia_permiso_descargas"
                            class="input input-bordered w-full"
                            value="{{ tarificador.vigencia_permiso_descargas if tarificador else '' }}" {% if
                            tarificador %}disabled{% endif %}>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Informe y Tabla -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--microscope] size-5 text-primary"></span>
                    <span>Datos del Informe</span>
                </div>
                <div class="card-body p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Laboratorio</label>
                            <input type="text" id="laboratorio" name="laboratorio" class="input input-bordered w-full"
                                value="{{ tarificador.laboratorio if tarificador else '' }}" {% if tarificador
                                %}disabled{% endif %}>
                        </div>
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Fecha
                                de Muestreo</label>
                            <input type="text" id="fecha_muestreo" name="fecha_muestreo"
                                class="input input-bordered w-full"
                                value="{{ tarificador.fecha_muestreo if tarificador else '' }}" {% if tarificador
                                %}disabled{% endif %}>
                        </div>
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Tipo
                                de
                                Muestreo</label>
                            <input type="text" id="tipo_muestreo" name="tipo_muestreo"
                                class="input input-bordered w-full"
                                value="{{ tarificador.tipo_muestreo if tarificador else '' }}" {% if tarificador
                                %}disabled{% endif %}>
                        </div>
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">No. de
                                Informe</label>
                            <input type="text" id="no_informe" name="no_informe" class="input input-bordered w-full"
                                value="{{ tarificador.no_informe if tarificador else '' }}" {% if tarificador
                                %}disabled{% endif %}>
                        </div>
                        <div class="form-control md:col-span-2 space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Volumen
                                Promedio Descargado (m³)</label>
                            <input type="number" step="0.01" id="volumen_promedio_descargado"
                                name="volumen_promedio_descargado" class="input input-bordered w-full font-bold"
                                value="{{ tarificador.volumen_promedio_descargado if tarificador else '' }}" {% if
                                tarificador %}disabled{% endif %} oninput="calculatePrices()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--table] size-5 text-info"></span>
                    <span>Resultados de Análisis</span>
                    <span
                        class="badge badge-soft badge-info font-bold uppercase tracking-widest text-[10px] ml-auto">Cálculo
                        Automático</span>
                </div>
                <div class="card-body p-0">
                    <div class="overflow-x-auto">
                        <table class="table table-lg">
                            <thead class="bg-base-200/30">
                                <tr>
                                    <th class="text-xs uppercase tracking-widest text-base-content/70 font-bold">
                                        Parámetro</th>
                                    <th class="text-xs uppercase tracking-widest text-base-content/70 w-24 font-bold">
                                        Resultado
                                    </th>
                                    <th class="text-xs uppercase tracking-widest text-base-content/70 w-24 font-bold">
                                        LMP</th>
                                    <th class="text-xs uppercase tracking-widest text-base-content/70 w-32 font-bold">
                                        Precio ($/m³)
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set rows = [
                                ('sst', 'SÓLIDOS SUSPENDIDOS TOTALES'),
                                ('dbo', 'DEMANDA BIOQUÍMICA DE OXÍGENO'),
                                ('gya', 'GRASA Y ACEITES'),
                                ('ss', 'SÓLIDOS SEDIMENTABLES'),
                                ('mf', 'MATERIA FLOTANTE'),
                                ('temp', 'TEMPERATURA'),
                                ('saam', 'SUSTANCIA ACTIVAS AL AZUL DE METILENO'),
                                ('dqo', 'DEMANDA QUÍMICA DE OXÍGENO'),
                                ('nt', 'NITROGENO TOTAL'),
                                ('fen', 'FENOLES'),
                                ('color', 'COLOR')
                                ] %}

                                {% for key, label in rows %}
                                <tr class="hover:bg-base-200/20 divide-x divide-base-content/5">
                                    <td class="text-xs font-bold text-base-content/80">{{ label }}</td>
                                    <td>
                                        <input type="text" name="{{ key }}_resultado"
                                            class="input input-sm input-ghost w-full text-center focus:bg-base-100"
                                            value="{{ tarificador[key + '_resultado'] if tarificador else '' }}" {% if
                                            tarificador %}disabled{% endif %} oninput="calculatePrices()">
                                    </td>
                                    <td class="bg-base-200/20">
                                        <input type="text" name="{{ key }}_lmp"
                                            class="input input-sm input-ghost w-full text-center font-medium always-locked"
                                            value="{{ tarificador[key + '_lmp'] if tarificador else default_lmps.get(key + '_lmp', '') }}"
                                            readonly tabindex="-1">
                                    </td>
                                    <td>
                                        <input type="text" name="{{ key }}_precio"
                                            class="input input-sm input-ghost w-full text-right font-black text-primary"
                                            value="{{ tarificador[key + '_precio'] if tarificador else '' }}" readonly
                                            tabindex="-1">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card bg-primary text-primary-content shadow-lg">
                <div class="card-body p-8">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="flex flex-col gap-1">
                            <span class="text-sm font-bold uppercase tracking-widest opacity-70">Precio Total por
                                m³:</span>
                            <div class="text-4xl font-black" id="subtotal-display">{{ tarificador.precio_m3_total if
                                tarificador else '$0.00' }}</div>
                        </div>
                        <div class="h-10 w-px bg-primary-content/20 hidden md:block"></div>
                        <div class="flex flex-col gap-1 items-center md:items-end">
                            <span class="text-sm font-bold uppercase tracking-widest opacity-70">Total Estimado a
                                Pagar:</span>
                            <div class="text-5xl font-black" id="total-display">{{ tarificador.total_pagar if
                                tarificador else '$0.00' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-4">
                <a href="{{ url_for('tarificador') }}" class="btn btn-ghost">Cancelar</a>
                <button type="submit"
                    class="btn btn-primary shadow-lg btn-wide {% if tarificador and not is_new %}hidden{% endif %}"
                    id="btn-submit">
                    <span class="icon-[tabler--device-floppy] size-5"></span>
                    Guardar Tarificador
                </button>
            </div>
        </div>
    </div>
</form>

<script id="clients-data" type="application/json">{{ clientes|tojson|safe }}</script>
<script id="rangos-data" type="application/json">{{ rangos|tojson|safe }}</script>

<script>
    const clientsData = JSON.parse(document.getElementById('clients-data').textContent);
    const rangosData = JSON.parse(document.getElementById('rangos-data').textContent);

    function enableEdit() {
        document.querySelectorAll('input, textarea, select').forEach(el => el.disabled = false);
        document.querySelectorAll('input.always-locked').forEach(el => el.readOnly = true);

        const btnSubmit = document.getElementById('btn-submit');
        if (btnSubmit) btnSubmit.classList.remove('hidden');

        const btnEdit = document.getElementById('btn-editar');
        if (btnEdit) btnEdit.classList.add('hidden');
    }

    function normalizeStr(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    function fillClient(input) {
        const val = normalizeStr(input.value);
        const box = document.getElementById('suggestions-box');
        box.innerHTML = '';
        box.classList.add('hidden');

        if (!val) return;

        const matches = clientsData.filter(c => normalizeStr(c.nombre_empresa || '').includes(val));

        if (matches.length > 0) {
            box.classList.remove('hidden');
            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-base-200 cursor-pointer border-b border-base-content/5 last:border-0';
                div.innerHTML = `<div class="font-bold text-sm">${match.nombre_empresa}</div><div class="text-xs opacity-60">${match.id_cliente || ''}</div>`;
                div.onclick = () => selectClient(match);
                box.appendChild(div);
            });
        }
    }

    function selectClient(client) {
        document.getElementById('nombre_cliente').value = client.nombre_empresa;
        if (document.getElementById('direccion_cliente')) document.getElementById('direccion_cliente').value = client.direccion_empresa || '';
        document.getElementById('suggestions-box').classList.add('hidden');

        if (document.getElementById('no_cliente')) document.getElementById('no_cliente').value = client.id_cliente || '';
        if (document.getElementById('no_permiso_descargas')) document.getElementById('no_permiso_descargas').value = client.no_permiso_descargas || '';
        if (document.getElementById('vigencia_permiso_descargas')) document.getElementById('vigencia_permiso_descargas').value = client.vegencia_permiso_descargas || '';
    }

    document.addEventListener('click', (e) => {
        if (e.target.id !== 'nombre_cliente') document.getElementById('suggestions-box').classList.add('hidden');
    });

    const CONTAMINANTES = ['sst', 'dbo', 'gya', 'ss', 'mf', 'temp', 'saam', 'dqo', 'nt', 'fen', 'color'];

    function cleanFloat(val) {
        if (!val) return 0;
        return parseFloat(val.toString().replace(/[$,]/g, '')) || 0;
    }

    function formatMoneySimple(amount) {
        return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
    }

    function calculatePrices() {
        let precioM3Total = 0;

        CONTAMINANTES.forEach(key => {
            const resInput = document.getElementsByName(`${key}_resultado`)[0];
            const lmpInput = document.getElementsByName(`${key}_lmp`)[0];
            const precioInput = document.getElementsByName(`${key}_precio`)[0];

            if (!resInput || !lmpInput || !precioInput) return;

            const res = cleanFloat(resInput.value);
            const lmp = cleanFloat(lmpInput.value);

            let price = 0;
            if (lmp > 0) {
                const ratio = (res - lmp) / lmp;
                if (ratio > 0) {
                    for (const r of rangosData) {
                        const max = r.max === null ? Infinity : r.max;
                        if (ratio > r.min && ratio <= max) {
                            price = r.price;
                            break;
                        }
                    }
                }
            }
            precioInput.value = formatMoneySimple(price);
            precioM3Total += price;
        });

        document.getElementById('subtotal-display').textContent = formatMoneySimple(precioM3Total);
        const volInput = document.getElementById('volumen_promedio_descargado');
        const volumen = cleanFloat(volInput?.value);
        document.getElementById('total-display').textContent = formatMoneySimple(precioM3Total * volumen);
    }

    document.addEventListener('DOMContentLoaded', () => calculatePrices());
</script>
{% endblock %}