{% extends 'base.html' %}

{% block extra_head %}
{% endblock %}

{% block content %}
<header class="flex justify-between items-center">
    <div>
        <h1>{{ 'Detalle Cotización' if cotizacion else 'Nueva Cotización' }}</h1>
        <p class="subtitle">{{ 'Consulta y edita los detalles.' if cotizacion else 'Complete el formulario para
            registrar una nueva cotización.' }}</p>
    </div>
    {% if cotizacion %}
    <div class="flex gap-4">
        <a href="{{ url_for('ver_cotizacion', folio=cotizacion.folio_cot) }}" target="_blank"
            class="btn btn-secondary">Ver PDF</a>
        <button type="button" class="btn btn-primary" onclick="enableEdit()" id="btn-editar">Editar</button>
    </div>
    {% endif %}
</header>

<form action="{{ url_for('nueva_cotizacion') }}" method="POST" class="card">
    <input type="hidden" name="original_folio" value="{{ cotizacion.folio_cot if cotizacion else '' }}">
    <div class="grid-2 mb-4">
        <div class="form-group">
            <label for="folio_cot">Folio Cotización</label>
            <input type="text" id="folio_cot" name="folio_cot" placeholder="Ej. COT-COPHI-001"
                value="{{ suggested_folio }}" required {% if cotizacion %}readonly class="readonly-bg" {% endif %}>
        </div>
        <div class="form-group">
            <label for="fecha_cot">Fecha</label>
            <input type="date" id="fecha_cot" name="fecha_cot" value="{{ cotizacion.fecha_cot if cotizacion else '' }}"
                {% if cotizacion %}disabled{% endif %}>
        </div>
    </div>

    <div class="grid-2 mb-4">
        <div class="form-group relative">
            <label for="nombre_cliente">Cliente</label>
            <input type="text" id="nombre_cliente" name="nombre_cliente" placeholder="Buscar o escribir nuevo..."
                autocomplete="off" oninput="fillClient(this)" required
                value="{{ cotizacion.nombre_cliente if cotizacion else '' }}" {% if cotizacion %}disabled{% endif %}>
            <div id="suggestions-box"></div>
        </div>
        <div class="form-group">
            <label for="razon_social_cliente">Razón Social</label>
            <input type="text" id="razon_social_cliente" name="razon_social_cliente"
                value="{{ cotizacion.razon_social_cliente if cotizacion else '' }}" {% if cotizacion %}disabled{% endif
                %}>
        </div>
        <div class="form-group col-span-2">
            <label for="direccion_cliente">Dirección</label>
            <input type="text" id="direccion_cliente" name="direccion_cliente"
                value="{{ cotizacion.direccion_cliente if cotizacion else '' }}" {% if cotizacion %}disabled{% endif %}>
        </div>
        <div class="form-group">
            <label for="nombre_contacto">Contacto</label>
            <input type="text" id="nombre_contacto" name="nombre_contacto"
                value="{{ cotizacion.nombre_contacto if cotizacion else '' }}" {% if cotizacion %}disabled{% endif %}>
        </div>
        <div class="form-group">
            <label for="telefono_contacto">Teléfono</label>
            <input type="text" id="telefono_contacto" name="telefono_contacto"
                value="{{ cotizacion.telefono_contacto if cotizacion else '' }}" {% if cotizacion %}disabled{% endif %}>
        </div>
    </div>

    <h3>Detalles del Servicio</h3>
    <div class="form-group">
        <label for="alcance_cot">Alcance (Descripción General)</label>
        <textarea id="alcance_cot" name="alcance_cot" rows="3" {% if cotizacion %}disabled{% endif
            %}>{{ cotizacion.alcance_cot if cotizacion else '' }}</textarea>
    </div>

    <h3>Items / Conceptos</h3>
    <div id="items-container">
        {% if cotizacion and cotizacion.conceptos %}
        {% for item in cotizacion.conceptos %}
        <div class="items-section item-row">
            <div>
                <label class="label-small">Nombre Item</label>
                <input type="text" name="nombre_item[]" list="inventory_list" onchange="fillItem(this)" required
                    placeholder="Buscar item..." value="{{ item.nombre_item }}" disabled>
            </div>
            <div>
                <label class="label-small">Descripción</label>
                <input type="text" name="descripcion_item[]" value="{{ item.descripcion_item }}" disabled>
            </div>
            <div>
                <label class="label-small">Unidad</label>
                <input type="text" name="unidad_item[]" placeholder="pza, servicio..." value="{{ item.unidad_item }}"
                    disabled>
            </div>
            <div>
                <label class="label-small">Cant.</label>
                <input type="number" step="1" name="cantidad_item[]" required value="{{ item.cantidad_item }}" disabled
                    oninput="calculateTotals()">
            </div>
            <div>
                <label class="label-small">Precio U.</label>
                <input type="number" step="0.01" name="precio_unitario_item[]" required
                    value="{{ item.precio_unitario_item }}" disabled oninput="calculateTotals()">
            </div>
            <div class="pt-6">
                <span class="remove-item {% if cotizacion %}hidden{% endif %}" onclick="removeItem(this)">✕</span>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <button type="button" class="btn btn-secondary mb-4 {% if cotizacion %}hidden{% endif %}" onclick="addItem()"
        id="btn-add-item">+ Agregar Item</button>

    <div class="card bg-gray-50 mt-4 p-4">
        <div class="flex flex-col items-end gap-2">
            <div class="flex justify-between w-64">
                <span class="font-bold">Subtotal:</span>
                <span id="subtotal-display">$0.00</span>
            </div>
            <div class="flex justify-between w-64 text-gray-600">
                <span>IVA (16%):</span>
                <span id="iva-display">$0.00</span>
            </div>
            <div class="flex justify-between w-64 text-xl font-bold border-t pt-2 mt-2">
                <span>Total:</span>
                <span id="total-display" class="text-primary">$0.00</span>
            </div>
        </div>
    </div>


    <h3>Términos y Condiciones</h3>
    <div class="form-group">
        <label for="terminos">Texto de Términos</label>
        <textarea id="terminos" name="terminos" rows="4" {% if cotizacion %}disabled{% endif
            %}>{{ cotizacion.terminos if cotizacion else 'El pago se realizará 50% anticipo y 50% contra entrega. Precios más IVA. Validez de la oferta: 15 días.' }}</textarea>
    </div>

    <div class="text-right mt-8 flex justify-end gap-4">
        <a href="{{ url_for('cotizaciones') }}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary {% if cotizacion %}hidden{% endif %}" id="btn-submit">Guardar
            Cotización</button>
    </div>
</form>

<!-- Datalist for items (hidden, used by JS) -->
<datalist id="inventory_list">
    {% for item in inventario %}
    <option value="{{ item.Nombre }}" data-desc="{{ item.Nombre }}" data-unit="{{ item.Unidad }}"
        data-price="{{ item.Precio }}">{{ item.Nombre }}</option>
    {% endfor %}
</datalist>

<script id="clients-data" type="application/json">{{ clientes|tojson|safe }}</script>

<script>
    const clientsData = JSON.parse(document.getElementById('clients-data').textContent);

    function enableEdit() {
        // Enable all inputs
        document.querySelectorAll('input, textarea, select').forEach(el => el.disabled = false);

        // Unlock Readonly inputs (Folio)
        document.querySelectorAll('input[readonly]').forEach(el => {
            el.readOnly = false;
            el.classList.remove('readonly-bg');
        });

        // Show buttons
        const btnAdd = document.getElementById('btn-add-item');
        if (btnAdd) btnAdd.classList.remove('hidden');

        const btnSubmit = document.getElementById('btn-submit');
        if (btnSubmit) btnSubmit.classList.remove('hidden');

        // Show delete icons
        document.querySelectorAll('.remove-item').forEach(el => el.classList.remove('hidden'));

        // Hide Edit button itself
        const btnEdit = document.getElementById('btn-editar');
        if (btnEdit) btnEdit.classList.add('hidden');
    }
</script>
<script src="{{ url_for('static', filename='crear_cotizacion.js') }}"></script>
{% endblock %}