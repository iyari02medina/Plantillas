{% extends 'base_flyonui.html' %}

{% block title %}{{ 'Nueva Orden de Trabajo' if is_new else 'Detalle Orden' }} - Sistema Cophi{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
    <div>
        <div class="flex items-center gap-2 mb-1">
            <a href="{{ url_for('ordenes') }}" class="btn btn-sm btn-ghost btn-circle" title="Volver">
                <span class="icon-[tabler--arrow-left] size-5"></span>
            </a>
            <h1 class="text-3xl font-bold text-base-content">{{ 'Nueva' if is_new else 'Detalle' }} Orden de Trabajo
            </h1>
        </div>
        <p class="text-base-content/60 font-medium ml-10 uppercase tracking-widest text-xs font-black">
            Módulo de {{ tipo|upper if tipo else 'ORDEN' }}
        </p>
    </div>
    {% if not is_new %}
    <div class="flex gap-2">
        <a href="{{ url_for('ver_orden_pdf', tipo=tipo, folio=folio) }}" target="_blank"
            class="btn btn-soft btn-secondary">
            <span class="icon-[tabler--file-type-pdf] size-5"></span>
            Ver PDF
        </a>
        <button type="button" class="btn btn-primary shadow-sm" onclick="enableEdit()" id="btn-editar">
            <span class="icon-[tabler--edit] size-5"></span>
            Editar
        </button>
    </div>
    {% endif %}
</div>

<form action="{{ url_for('nueva_orden', tipo=tipo) if is_new else url_for('detalle_orden', tipo=tipo, folio=folio) }}"
    method="POST" enctype="multipart/form-data" class="space-y-8 pb-20">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Columna Izquierda: Identificación -->
        <div class="lg:col-span-1 space-y-6">
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--hash] size-5 text-primary"></span>
                    <span>Datos del Folio</span>
                </div>
                <div class="card-body p-6 space-y-4">
                    <div class="form-control space-y-2">
                        <label
                            class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Folio</label>
                        <input type="text"
                            name="folio_{{ 'des' if tipo=='desazolve' else 'lt' if tipo=='trampa' else 'vt' }}"
                            value="{{ folio }}" readonly required
                            class="input input-bordered w-full font-black text-primary">
                    </div>
                    <div class="form-control space-y-2">
                        <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Fecha de
                            Servicio</label>
                        <input type="text"
                            name="fecha_{{ 'des' if tipo=='desazolve' else 'lt' if tipo=='trampa' else 'vt' }}"
                            value="{{ orden.get('fecha_' + ( 'des' if tipo=='desazolve' else 'lt' if tipo=='trampa' else 'vt' ), todays_date) }}"
                            class="input input-bordered w-full font-bold" readonly>
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--user] size-5 text-secondary"></span>
                    <span>Información del Cliente</span>
                </div>
                <div class="card-body p-6 space-y-4">
                    <div class="form-control relative space-y-2">
                        <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Nombre /
                            Empresa</label>
                        <input type="text" id="nombre_cliente" name="cliente" placeholder="Buscar..." autocomplete="off"
                            class="input input-bordered w-full font-bold" oninput="fillClient(this)" required
                            value="{{ orden.get('cliente', '') }}" {{ 'disabled' if not is_new else '' }}>
                        <div id="suggestions-box"
                            class="absolute z-50 w-full mt-1 bg-base-100 border border-base-content/10 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden">
                        </div>
                    </div>
                    <div class="form-control space-y-2">
                        <label
                            class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Dirección</label>
                        <textarea id="direccion_cliente" name="direccion" class="textarea textarea-bordered w-full"
                            rows="2" {{ 'disabled' if not is_new else '' }}>{{ orden.get('direccion', '') }}</textarea>
                    </div>
                    <div class="form-control space-y-2">
                        <label
                            class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Teléfono</label>
                        <input type="text" id="telefono_cliente" name="telefono" class="input input-bordered w-full"
                            value="{{ orden.get('telefono', '') }}" {{ 'disabled' if not is_new else '' }}>
                    </div>
                </div>
            </div>

            {% if tipo == 'desazolve' or tipo == 'trampa' %}
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--clock] size-5 text-info"></span>
                    <span>Horarios de Servicio</span>
                </div>
                <div class="card-body p-6 grid grid-cols-2 gap-4">
                    <div class="form-control space-y-2">
                        <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Hora
                            Inicial</label>
                        <input type="text" name="hora_inicial" class="input input-bordered w-full"
                            value="{{ orden.get('hora_inicial', '') }}" {{ 'disabled' if not is_new else '' }}>
                    </div>
                    <div class="form-control space-y-2">
                        <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Hora
                            Final</label>
                        <input type="text" name="hora_final" class="input input-bordered w-full"
                            value="{{ orden.get('hora_final', '') }}" {{ 'disabled' if not is_new else '' }}>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Columna Derecha: Detalles del Servicio -->
        <div class="lg:col-span-2 space-y-6">

            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--clipboard-check] size-5 text-success"></span>
                    <span>Detalles Técnicos y Observaciones</span>
                </div>
                <div class="card-body p-6 space-y-6">

                    {% if tipo == 'desazolve' %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Ubicación
                                del Servicio</label><input type="text" name="ubicacion"
                                class="input input-bordered w-full" value="{{ orden.get('ubicacion', '') }}"
                                {{ 'disabled' if not is_new else '' }}></div>
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Metros de
                                Manguera</label><input type="text" name="metros_manguera"
                                class="input input-bordered w-full" value="{{ orden.get('metros_manguera', '') }}"
                                {{ 'disabled' if not is_new else '' }}></div>
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Tramo /
                                Línea</label><input type="text" name="tramo" class="input input-bordered w-full"
                                value="{{ orden.get('tramo', '') }}" {{ 'disabled' if not is_new else '' }}></div>
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Condición
                                Final</label><input type="text" name="condicion_final"
                                class="input input-bordered w-full" value="{{ orden.get('condicion_final', '') }}"
                                {{ 'disabled' if not is_new else '' }}></div>
                    </div>
                    {% elif tipo == 'trampa' %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Ubicación
                                de la Trampa</label><input type="text" name="ubicacion"
                                class="input input-bordered w-full" value="{{ orden.get('ubicacion', '') }}"
                                {{ 'disabled' if not is_new else '' }}></div>
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Capacidad
                                (Litros)</label><input type="text" name="capacidad" class="input input-bordered w-full"
                                value="{{ orden.get('capacidad', '') }}" {{ 'disabled' if not is_new else '' }}></div>
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Residuos
                                Retirados</label><input type="text" name="residuos" class="input input-bordered w-full"
                                value="{{ orden.get('residuos', '') }}" {{ 'disabled' if not is_new else '' }}></div>
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Estado de
                                la Trampa</label><input type="text" name="estado_trampa"
                                class="input input-bordered w-full" value="{{ orden.get('estado_trampa', '') }}"
                                {{ 'disabled' if not is_new else '' }}></div>
                    </div>
                    {% elif tipo == 'visita' %}
                    <div class="form-control space-y-2">
                        <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Motivo de
                            la Visita</label>
                        <input type="text" name="motivo" class="input input-bordered w-full"
                            value="{{ orden.get('motivo', '') }}" {{ 'disabled' if not is_new else '' }}>
                    </div>
                    {% endif %}

                    <div class="form-control space-y-2">
                        <label
                            class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Observaciones
                            Generales</label>
                        <textarea name="observaciones" class="textarea textarea-bordered w-full" rows="4" {{ 'disabled'
                            if not is_new else '' }}>{{ orden.get('observaciones', '') }}</textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Nombre de
                                quien Recibe</label><input type="text" name="nombre_recibe"
                                class="input input-bordered w-full" value="{{ orden.get('nombre_recibe', '') }}"
                                {{ 'disabled' if not is_new else '' }}></div>
                        <div class="form-control space-y-2"><label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Nombre
                                del
                                Técnico</label><input type="text" name="tecnico_nombre"
                                class="input input-bordered w-full" value="{{ orden.get('tecnico_nombre', '') }}"
                                {{ 'disabled' if not is_new else '' }}></div>
                    </div>
                </div>
            </div>

            <!-- Evidencia Fotográfica -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--camera] size-5 text-warning"></span>
                    <span>Evidencia Fotográfica</span>
                </div>
                <div class="card-body p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest justify-center">Antes
                                del
                                Servicio</label>
                            <div class="flex flex-col items-center gap-4">
                                {% if orden.foto_antes %}
                                <div
                                    class="relative group w-full aspect-video rounded-xl overflow-hidden border border-base-content/10">
                                    <img src="{{ url_for('static', filename='uploads/' + orden.foto_antes) }}"
                                        class="w-full h-full object-cover">
                                </div>
                                {% endif %}
                                <input type="file" name="foto_antes"
                                    class="file-input file-input-bordered file-input-primary w-full max-w-xs"
                                    {{ 'disabled' if not is_new else '' }}>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest justify-center">Después
                                del
                                Servicio</label>
                            <div class="flex flex-col items-center gap-4">
                                {% if orden.foto_despues %}
                                <div
                                    class="relative group w-full aspect-video rounded-xl overflow-hidden border border-base-content/10">
                                    <img src="{{ url_for('static', filename='uploads/' + orden.foto_despues) }}"
                                        class="w-full h-full object-cover">
                                </div>
                                {% endif %}
                                <input type="file" name="foto_despues"
                                    class="file-input file-input-bordered file-input-primary w-full max-w-xs"
                                    {{ 'disabled' if not is_new else '' }}>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4">
                <a href="{{ url_for('ordenes') }}" class="btn btn-ghost">Cancelar</a>
                <button type="submit" class="btn btn-primary btn-wide shadow-lg {{ 'hidden' if not is_new else '' }}"
                    id="btn-submit">
                    <span class="icon-[tabler--device-floppy] size-5"></span>
                    {{ 'Guardar Orden de Trabajo' if is_new else 'Actualizar Orden' }}
                </button>
            </div>
        </div>
    </div>
</form>

<script id="clients-data" type="application/json">{{ clientes|tojson|safe }}</script>

<script>
    const clientsData = JSON.parse(document.getElementById('clients-data').textContent);

    function enableEdit() {
        document.querySelectorAll('input, select, textarea').forEach(el => {
            const name = el.getAttribute('name');
            if (name && !name.startsWith('folio_') && !name.startsWith('fecha_')) { // Protegemos inputs de folio y fecha para que sigan readonly
                el.disabled = false;
            }
        });

        const btnSubmit = document.getElementById('btn-submit');
        if (btnSubmit) btnSubmit.classList.remove('hidden');
        const btnEdit = document.getElementById('btn-editar');
        if (btnEdit) btnEdit.classList.add('hidden');
    }

    function normalizeStr(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    function fillClient(input) {
        const val = normalizeStr(input.value);
        const box = document.getElementById('suggestions-box');
        box.innerHTML = '';
        box.classList.add('hidden');

        if (!val) return;

        const matches = clientsData.filter(c => normalizeStr(c.nombre_empresa || '').includes(val));

        if (matches.length > 0) {
            box.classList.remove('hidden');
            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-base-200 cursor-pointer border-b border-base-content/5 last:border-0';
                div.innerHTML = `<div class="font-bold text-sm text-base-content">${match.nombre_empresa}</div><div class="text-xs text-base-content/50">${match.id_cliente || ''}</div>`;
                div.onclick = () => selectClient(match);
                box.appendChild(div);
            });
        }
    }

    function selectClient(client) {
        document.getElementById('nombre_cliente').value = client.nombre_empresa;
        if (document.getElementById('direccion_cliente')) document.getElementById('direccion_cliente').value = client.direccion_empresa || '';
        if (document.getElementById('telefono_cliente')) document.getElementById('telefono_cliente').value = client.telefono_empresa || '';
        document.getElementById('suggestions-box').classList.add('hidden');
    }

    document.addEventListener('click', () => {
        document.getElementById('suggestions-box').classList.add('hidden');
    });
</script>
{% endblock %}