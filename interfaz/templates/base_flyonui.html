<!DOCTYPE html>
<html lang="es" data-theme="light" dir="ltr" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <title>{% block title %}Sist. Gestión - Cophi{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/gota-cophi.jpg') }}" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap"
        rel="stylesheet" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='flyonui/dist/css/output.css') }}" />

    <!-- Existing Styles (optional fallback) -->
    <style>
        /* Small adjustments to integrate existing card logic if needed */
        .msg-error {
            border-left: 4px solid #ef4444 !important;
        }

        .msg-success {
            border-left: 4px solid #10b981 !important;
        }

        /* TEMA PERSONALIZADO COPHI - FORZADO */
        :root,
        [data-theme="light"] {
            /* Primary: #0099cf (Azul Cian) */
            --p: 196 100% 41%;
            --pc: 0 0% 100%;

            /* Secondary: #6ebe43 (Verde Lima) */
            --s: 99 48% 50%;
            --sc: 0 0% 100%;

            /* Custom Dark: #2d3e50 */
            --n: 211 28% 25%;
            --nc: 0 0% 100%;

            /* Base content */
            --bc: 215 19% 35%;
        }

        /* Clases de utilidad para el nuevo color */
        .bg-cophi-dark {
            background-color: #2d3e50 !important;
            color: #ffffff !important;
        }

        .text-cophi-dark {
            color: #2d3e50 !important;
        }

        /* SOBRESCRIBIR COMPONENTES ESPECÍFICOS QUE NO OBEDECEN VARIABLES */

        /* Botones Primarios (Nueva Cotización, etc) */
        .btn-primary,
        .btn.btn-primary,
        [class*="btn-primary"] {
            background-color: #0099cf !important;
            border-color: #0099cf !important;
            color: #ffffff !important;
        }

        .btn-primary:hover,
        .btn.btn-primary:hover {
            background-color: #007bb5 !important;
            /* Un poco más oscuro */
            border-color: #007bb5 !important;
        }

        /* Botones suaves/texto (Ver Doc) */
        .btn-soft.btn-primary {
            background-color: rgba(0, 153, 207, 0.1) !important;
            /* Azul muy suave */
            color: #0099cf !important;
            border: none !important;
        }

        .btn-soft.btn-primary:hover {
            background-color: rgba(0, 153, 207, 0.2) !important;
        }

        /* Texto Primario (Títulos, enlaces) */
        .text-primary {
            color: #0099cf !important;
        }

        /* Menú Activo (Sidebar) */
        .menu-active {
            background-color: #0099cf !important;
            color: white !important;
        }

        /* Ajustes para Sidebar Oscuro */
        #layout-sidebar .menu li a:not(.menu-active) {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        #layout-sidebar .menu li a:not(.menu-active):hover {
            color: #ffffff !important;
            background-color: rgba(255, 255, 255, 0.1) !important;
        }

        #layout-sidebar .menu li a i,
        #layout-sidebar .menu li a span[class^="icon-"] {
            color: inherit !important;
        }

        #layout-sidebar .menu li {
            color: #ffffff !important;
        }

        /* Buscador del Header */
        .input-header-search {
            background-color: #2d3e50 !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            color: white !important;
        }

        .input-header-search input {
            color: white !important;
        }

        .input-header-search input::placeholder {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .input-header-search .icon-[tabler--search] {
            color: white !important;
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>

<body>
    <!-- Layout Wrapper -->
    <div class="bg-base-200 flex min-h-screen flex-col">

        <!-- HEADER -->
        <header class="bg-cophi-dark border-base-content/20 lg:ps-75 sticky top-0 z-50 flex border-b">
            <div class="w-full" style="padding-right: 24px;">
                <nav class="bg-cophi-dark navbar py-4 px-4">
                    <div class="flex-1 flex items-center gap-2">
                        <button type="button" class="btn btn-soft btn-square btn-sm lg:hidden" aria-haspopup="dialog"
                            aria-expanded="false" aria-controls="layout-sidebar" data-overlay="#layout-sidebar">
                            <span class="icon-[tabler--menu-2] size-4.5"></span>
                        </button>
                        <div class="flex items-center gap-2 flex-1 w-full">
                            <button type="button"
                                class="input input-header-search input-md flex w-full space-x-4 cursor-text text-start"
                                onclick="toggleSearchModal(true)">
                                <span class="icon-[tabler--search] my-auto size-6 shrink-0 opacity-80"></span>
                                <span class="grow text-white/50 my-auto text-sm font-normal">Buscar</span>
                            </button>
                        </div>
                    </div>

                    <div class="flex-none flex items-center gap-2">
                        <!-- Quick Links -->
                        <div class="flex items-center gap-1 mr-2">
                            <!-- Links to hide on mobile -->
                            <div class="flex items-center gap-1 max-md:hidden">
                                <!-- Gmail -->
                                <a href="https://mail.google.com" target="_blank"
                                    class="btn btn-text btn-circle hover:bg-white/10" title="Gmail">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                                        viewBox="0 0 256 193">
                                        <path fill="#4285F4"
                                            d="M58.182 192.05V93.14L27.507 65.077L0 49.504v125.091c0 9.658 7.825 17.455 17.455 17.455z" />
                                        <path fill="#34A853"
                                            d="M197.818 192.05h40.727c9.659 0 17.455-7.826 17.455-17.455V49.505l-31.156 17.837l-27.026 25.798z" />
                                        <path fill="#EA4335"
                                            d="m58.182 93.14l-4.174-38.647l4.174-36.989L128 69.868l69.818-52.364l4.669 34.992l-4.669 40.644L128 145.504z" />
                                        <path fill="#FBBC04"
                                            d="M197.818 17.504V93.14L256 49.504V26.231c0-21.585-24.64-33.89-41.89-20.945z" />
                                        <path fill="#C5221F"
                                            d="m0 49.504l26.759 20.07L58.182 93.14V17.504L41.89 5.286C24.61-7.66 0 4.646 0 26.23z" />
                                    </svg>
                                </a>
                                <!-- Google Drive -->
                                <a href="https://drive.google.com" target="_blank"
                                    class="btn btn-text btn-circle hover:bg-white/10" title="Google Drive">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                                        viewBox="0 0 256 222.3">
                                        <path fill="#0066DA"
                                            d="m19.354 186.732l11.29 19.5c2.346 4.106 5.718 7.332 9.677 9.678q17.009-21.591 23.68-33.137q6.77-11.717 16.641-36.655q-26.604-3.502-40.32-3.502q-13.165 0-40.322 3.502c0 4.545 1.173 9.09 3.519 13.196z" />
                                        <path fill="#EA4335"
                                            d="M211.528 215.91c3.96-2.346 7.332-5.572 9.677-9.677l4.692-8.064l22.434-38.855a26.57 26.57 0 0 0 3.518-13.196q-27.315-3.502-40.247-3.502q-13.899 0-40.248 3.502q9.754 25.075 16.422 36.655q6.724 11.683 23.752 33.137" />
                                        <path fill="#00832D"
                                            d="M123.848 64.009q19.68-23.768 27.125-36.655q5.996-10.377 13.196-33.137C160.21 1.173 155.665 0 150.973 0H96.723c-4.692 0-9.237 1.32-13.196 3.519q9.16 26.103 15.544 37.154q7.056 12.213 24.777 32.638" />
                                        <path fill="#2684FC"
                                            d="m171.207 146.118h-94.717l-40.32 69.792c3.958 2.346 8.503 3.519 13.195 3.519h148.968c4.692 0 9.238-1.32 13.196-3.52z" />
                                        <path fill="#00AC47"
                                            d="M123.848 64.009L83.528 0c-3.96 2.346-7.332 5.571-9.678 9.677L3.519 132.922a26.57 26.57 0 0 0 0 13.196h80.642z" />
                                        <path fill="#FFBA00"
                                            d="m211.089 68.411l-37.243-64.514c-2.345-4.106-5.718-7.331-9.677-9.677l-40.32 69.792l47.358 82.109h80.496c0-4.546-1.173-9.09-3.519-13.196z" />
                                    </svg>
                                </a>
                                <!-- Google Calendar -->
                                <a href="https://calendar.google.com" target="_blank"
                                    class="btn btn-text btn-circle hover:bg-white/10" title="Google Calendar">
                                    <svg width="22" height="22" viewBox="0 0 512 512" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M390.736 121.264H121.264V390.736H390.736V121.264Z" fill="white" />
                                        <path
                                            d="M390.736 512L512 390.736L451.368 380.392L390.736 390.736L379.67 446.196L390.736 512Z"
                                            fill="#EA4335" />
                                        <path
                                            d="M0 390.736V471.578C0 493.912 18.088 512 40.42 512H121.264L133.714 451.368L121.264 390.736L55.198 380.392L0 390.736Z"
                                            fill="#188038" />
                                        <path
                                            d="M512 121.264V40.42C512 18.088 493.912 0 471.58 0H390.736C383.36 30.072 379.671 52.2027 379.67 66.392C379.67 80.58 383.359 98.8707 390.736 121.264C417.556 128.944 437.767 132.784 451.368 132.784C464.969 132.784 485.18 128.945 512 121.264Z"
                                            fill="#1967D2" />
                                        <path d="M512 121.264H390.736V390.736H512V121.264Z" fill="#FBBC04" />
                                        <path d="M390.736 390.736H121.264V512H390.736V390.736Z" fill="#34A853" />
                                        <path
                                            d="M390.736 0H40.422C18.088 0 0 18.088 0 40.42V390.736H121.264V121.264H390.736V0Z"
                                            fill="#4285F4" />
                                        <path
                                            d="M176.54 330.308C166.468 323.504 159.494 313.568 155.688 300.428L179.066 290.796C181.186 298.88 184.891 305.145 190.182 309.592C195.436 314.038 201.836 316.228 209.314 316.228C216.959 316.228 223.527 313.903 229.018 309.254C234.51 304.606 237.272 298.678 237.272 291.504C237.272 284.16 234.375 278.164 228.582 273.516C222.788 268.868 215.512 266.544 206.822 266.544H193.314V243.404H205.44C212.917 243.404 219.216 241.382 224.336 237.338C229.456 233.298 232.016 227.772 232.016 220.732C232.016 214.468 229.726 209.482 225.146 205.744C220.566 202.004 214.77 200.118 207.73 200.118C200.858 200.118 195.402 201.938 191.36 205.608C187.319 209.289 184.282 213.937 182.534 219.116L159.394 209.482C162.458 200.792 168.084 193.112 176.336 186.476C184.588 179.84 195.132 176.506 207.932 176.506C217.398 176.506 225.92 178.326 233.466 181.996C241.01 185.668 246.938 190.754 251.216 197.222C255.496 203.722 257.616 210.998 257.616 219.082C257.616 227.334 255.63 234.308 251.656 240.034C247.682 245.76 242.796 250.138 237.002 253.204V254.584C244.483 257.669 250.982 262.735 255.798 269.238C260.682 275.806 263.142 283.654 263.142 292.818C263.142 301.978 260.816 310.164 256.168 317.338C251.52 324.514 245.088 330.172 236.934 334.282C228.75 338.392 219.554 340.482 209.348 340.482C197.524 340.514 186.612 337.112 176.54 330.308ZM320.132 214.298L294.466 232.858L281.632 213.39L327.678 180.176H345.328V336.842H320.132V214.298Z"
                                            fill="#4285F4" />
                                    </svg>
                                </a>
                                <!-- NotebookLM -->
                                <a href="https://notebooklm.google.com" target="_blank"
                                    class="btn btn-text btn-circle hover:bg-white/10" title="NotebookLM">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
                                        fill="#ffffff">
                                        <path
                                            d="M11.999 3.14C5.372 3.14 0 8.588 0 15.312v5.828h2.212v-.58c0-2.728 2.178-4.938 4.866-4.938 2.688 0 4.866 2.21 4.866 4.937v.581h2.212v-.58c0-3.967-3.17-7.18-7.078-7.18a6.966 6.966 0 00-4.086 1.318C4.2 12.262 6.687 10.59 9.56 10.59c4.057 0 7.347 3.338 7.347 7.453v3.097h2.212v-3.097c0-5.355-4.28-9.698-9.56-9.698a9.438 9.438 0 00-6.217 2.332C4.984 7.528 8.244 5.383 12 5.383c5.406 0 9.788 4.446 9.788 9.93v5.827H24v-5.828C23.999 8.588 18.627 3.14 11.999 3.14z">
                                        </path>
                                    </svg>
                                </a>
                                <!-- Web -->
                                <a href="#" target="_blank" class="btn btn-text btn-circle text-white hover:bg-white/10"
                                    title="Página Web">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="2" y1="12" x2="22" y2="12"></line>
                                        <path
                                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                                        </path>
                                    </svg>
                                </a>
                            </div>
                            <button class="btn btn-text btn-circle text-white hover:bg-white/10 relative"
                                title="Notificaciones">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                </svg>
                                <span class="absolute top-2 right-2 flex h-2 w-2">
                                    <span
                                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-error opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-2 w-2 bg-error"></span>
                                </span>
                            </button>
                        </div>

                        <!-- Profile Dropdown (Simplified) -->
                        <div class="dropdown relative inline-flex [--offset:21]">
                            <button id="profile-dropdown" type="button" class="dropdown-toggle avatar"
                                aria-haspopup="menu" aria-expanded="false" aria-label="Dropdown">
                                <span class="rounded-field size-9.5">
                                    <img src="{{ url_for('static', filename='flyonui/img/avatars/sparrow.jpeg') }}"
                                        alt="User Avatar" />
                                </span>
                            </button>
                            <ul class="dropdown-menu dropdown-open:opacity-100 max-w-75 hidden w-full space-y-0.5"
                                role="menu" aria-orientation="vertical" aria-labelledby="profile-dropdown">
                                <li class="dropdown-header pt-4.5 mb-1 gap-4 px-5 pb-3.5">
                                    <div class="avatar avatar-online-top">
                                        <div class="w-10 rounded-full">
                                            <img src="{{ url_for('static', filename='flyonui/img/avatars/sparrow.jpeg') }}"
                                                alt="avatar" />
                                        </div>
                                    </div>
                                    <div>
                                        <h6 class="text-base-content mb-0.5 font-semibold">Usuario Cophi</h6>
                                        <p class="text-base-content/80 font-medium">Administrador</p>
                                    </div>
                                </li>
                                <li>
                                    <hr class="border-base-content/20 -mx-2 my-1" />
                                </li>
                                <li class="dropdown-footer p-2 pt-1">
                                    <a class="btn btn-text btn-error btn-block h-11 justify-start px-3 font-normal"
                                        href="#">
                                        <span class="icon-[tabler--logout] size-5"></span>
                                        Cerrar Sesión
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Sidebar -->
        <aside id="layout-sidebar"
            class="overlay overlay-open:translate-x-0 drawer drawer-start sm:w-75 inset-y-0 start-0 hidden h-full [--auto-close:lg] lg:z-50 lg:block lg:translate-x-0 lg:shadow-none"
            aria-label="Sidebar" tabindex="-1">
            <div class="drawer-body border-white/10 h-full p-0 bg-cophi-dark">
                <div class="flex h-full max-h-full flex-col">
                    <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3 lg:hidden"
                        aria-label="Close" data-overlay="#layout-sidebar">
                        <span class="icon-[tabler--x] size-4.5"></span>
                    </button>

                    <div class="text-white border-white/10 flex flex-col items-center gap-2 border-b px-2 py-2">
                        <div class="flex justify-center w-full">
                            <img src="{{ url_for('static', filename='img/Logo-Cophi-blanco.png') }}"
                                style="width: 95px; height: auto;" alt="logo" />
                        </div>
                    </div>

                    <div class="h-full overflow-y-auto pt-4">
                        <ul class="menu menu-sm gap-1 px-4">
                            <li>
                                <a href="{{ url_for('index') }}"
                                    class="{% if request.endpoint == 'index' %}menu-active{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %} flex items-center gap-3 px-4 py-3 rounded-lg transition-all">
                                    <span class="icon-[tabler--dashboard] size-5"></span>
                                    <span class="font-medium">Dashboard</span>
                                </a>
                            </li>

                            <li class="text-white mt-4 px-4 text-xs font-bold uppercase tracking-widest">
                                Módulos</li>

                            <li>
                                <a href="{{ url_for('cotizaciones') }}"
                                    class="{% if request.endpoint == 'cotizaciones' %}menu-active{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %} flex items-center gap-3 px-4 py-3 rounded-lg transition-all">
                                    <!-- SVG directo para evitar problemas de compilación -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="icon icon-tabler icons-tabler-outline icon-tabler-pencil-dollar">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
                                        <path d="M13.5 6.5l4 4" />
                                        <path d="M21 15h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5" />
                                        <path d="M19 21v1m0 -8v1" />
                                    </svg>
                                    <span class="font-medium">Cotizaciones</span>
                                </a>
                            </li>
                            <li>
                                <a href="{{ url_for('ordenes') }}"
                                    class="{% if request.endpoint == 'ordenes' %}menu-active{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %} flex items-center gap-3 px-4 py-3 rounded-lg transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="icon icon-tabler icons-tabler-outline icon-tabler-tool">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path
                                            d="M7 10h3v-3l-3.5 -3.5a6 6 0 0 1 8 8l6 6a2 2 0 0 1 -3 3l-6 -6a6 6 0 0 1 -8 -8l3.5 3.5" />
                                    </svg>
                                    <span class="font-medium">Órdenes de Trabajo</span>
                                </a>
                            </li>
                            <li>
                                <a href="{{ url_for('tarificador') }}"
                                    class="{% if request.endpoint == 'tarificador' %}menu-active{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %} flex items-center gap-3 px-4 py-3 rounded-lg transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="icon icon-tabler icons-tabler-outline icon-tabler-microscope">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path d="M5 21h14" />
                                        <path d="M6 18h2" />
                                        <path d="M7 18v3" />
                                        <path d="M9 11l3 3l6 -6l-3 -3l-6 6" />
                                        <path d="M10.5 12.5l-1.5 1.5" />
                                        <path d="M17 3l3 3" />
                                        <path d="M12 21a6 6 0 0 0 3.715 -10.712" />
                                    </svg>
                                    <span class="font-medium">Análisis de Laboratorio</span>
                                </a>
                            </li>
                            <li>
                                <a href="{{ url_for('permisos_descarga') }}"
                                    class="{% if request.endpoint == 'permisos_descarga' %}menu-active{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %} flex items-center gap-3 px-4 py-3 rounded-lg transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="icon icon-tabler icons-tabler-outline icon-tabler-radioactive">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path d="M13.5 14.6l3 5.19a9 9 0 0 0 4.5 -7.79h-6a3 3 0 0 1 -1.5 2.6" />
                                        <path d="M13.5 9.4l3 -5.19a9 9 0 0 0 -9 0l3 5.19a3 3 0 0 1 3 0" />
                                        <path d="M10.5 14.6l-3 5.19a9 9 0 0 1 -4.5 -7.79h6a3 3 0 0 0 1.5 2.6" />
                                    </svg>
                                    <span class="font-medium">Permisos de Descarga</span>
                                </a>
                            </li>
                            <li>
                                <a href="{{ url_for('consumos') }}"
                                    class="{% if request.endpoint == 'consumos' %}menu-active{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %} flex items-center gap-3 px-4 py-3 rounded-lg transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="currentColor"
                                        class="icon icon-tabler icons-tabler-filled icon-tabler-droplet-half-2">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                        <path
                                            d="M13.905 2.923l.098 .135l4.92 7.306a7.566 7.566 0 0 1 1.043 3.167l.024 .326c.007 .047 .01 .094 .01 .143l-.002 .06c.056 2.3 -.944 4.582 -2.87 6.14c-2.969 2.402 -7.286 2.402 -10.255 0c-1.904 -1.54 -2.904 -3.787 -2.865 -6.071a1.052 1.052 0 0 1 .013 -.333a7.66 7.66 0 0 1 .913 -3.176l.172 -.302l4.893 -7.26c.185 -.275 .426 -.509 .709 -.686c1.055 -.66 2.446 -.413 3.197 .55zm-2.06 1.107l-.077 .038l-.041 .03l-.037 .036l-.033 .042l-4.863 7.214a5.607 5.607 0 0 0 -.651 1.61h11.723a5.444 5.444 0 0 0 -.49 -1.313l-.141 -.251l-4.891 -7.261a.428 .428 0 0 0 -.5 -.145z" />
                                    </svg>
                                    <span class="font-medium">Consumos de Agua</span>
                                </a>
                            </li>
                            <li>
                                <a href="{{ url_for('directorio') }}"
                                    class="{% if request.endpoint == 'directorio' %}menu-active{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %} flex items-center gap-3 px-4 py-3 rounded-lg transition-all">
                                    <span class="icon-[tabler--users] size-5"></span>
                                    <span class="font-medium">Directorio</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <div class="lg:ps-75 flex-1 transition-all duration-300" style="max-width: 97vw;">
            <main style="margin-left: 24px; margin-top: 24px; width: auto;">

                <!-- FLASH MESSAGES -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="mb-6 space-y-2">
                    {% for category, message in messages %}
                    <div class="alert {% if category=='error' %}alert-soft alert-error{% else %}alert-soft alert-success{% endif %} flex items-center gap-3 shadow-sm"
                        role="alert">
                        <span class="icon-[tabler--info-circle] size-5"></span>
                        <p class="text-sm font-medium">{{ message }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <!-- PAGE CONTENT -->
                {% block content %}{% endblock %}
            </main>

            <!-- Footer -->
            <footer class="mt-12 py-6 border-t border-base-content/10">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4 text-base-content/60 text-sm">
                    <p>© 2026 Cophi - Sistema de Gestión de Agua</p>
                    <div class="flex items-center gap-6">
                        <span class="flex items-center gap-1">
                            <span class="icon-[tabler--code] size-4"></span>
                            v1.2.0
                        </span>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <!-- FlyonUI JS -->
    <script src="{{ url_for('static', filename='flyonui/dist/libs/flyonui/flyonui.js') }}"></script>
    <!-- Theme Utils JS -->
    <script src="{{ url_for('static', filename='flyonui/dist/js/theme-utils.js') }}"></script>
    <!-- Main JS -->
    <script src="{{ url_for('static', filename='flyonui/dist/js/main.js') }}"></script>

    {% block scripts %}{% endblock %}
    <!-- Command Palette Modal (Strict Width & Centering) -->
    <div id="search-modal"
        class="fixed inset-0 grid place-items-center opacity-0 invisible transition-opacity duration-300"
        style="z-index: 9999; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);" role="dialog"
        aria-modal="true" onclick="if(event.target === this) toggleSearchModal(false)">

        <!-- Modal Content -->
        <div class="modal-content bg-base-100 rounded-xl shadow-2xl relative flex flex-col transition-all duration-300 ease-in-out transform scale-95 opacity-0"
            style="width: 600px; max-width: 90vw; max-height: 85vh; margin: auto;">

            <!-- Input Header -->
            <div class="flex items-center gap-3 px-4 py-4 border-b border-base-content/10">
                <span class="icon-[tabler--search] size-5 text-primary"></span>
                <input type="text" id="global-search-input"
                    class="flex-1 bg-transparent border-0 outline-none text-lg font-medium placeholder:text-base-content/40 focus:ring-0 text-base-content"
                    placeholder="Buscar página, módulo o acción..." autocomplete="off">
                <button onclick="toggleSearchModal(false)"
                    class="btn btn-sm btn-circle btn-ghost text-base-content/50 hover:bg-base-content/10">
                    <span class="icon-[tabler--x] size-5"></span>
                </button>
            </div>

            <!-- Results List -->
            <div class="overflow-y-auto p-2 flex-1 scrollbar-thin" id="search-results">
                <!-- Populated by JS -->
            </div>

            <!-- Footer Hints -->
            <div
                class="bg-base-200/50 border-t border-base-content/5 px-4 py-2 flex items-center gap-4 text-[10px] font-medium text-base-content/40 uppercase tracking-wider rounded-b-xl">
                <span class="flex items-center gap-1"><kbd class="kbd kbd-xs bg-base-100 border-base-content/10">↩</kbd>
                    seleccionar</span>
                <span class="flex items-center gap-1"><kbd
                        class="kbd kbd-xs bg-base-100 border-base-content/10">↑↓</kbd> navegar</span>
                <span class="flex items-center gap-1"><kbd
                        class="kbd kbd-xs bg-base-100 border-base-content/10">esc</kbd> cerrar</span>
            </div>
        </div>
    </div>

    <script>
        const searchModal = document.getElementById('search-modal');
        const modalContent = searchModal ? searchModal.querySelector('.modal-content') : null;
        const searchInput = document.getElementById('global-search-input');
        const searchResults = document.getElementById('search-results');

        let selectedIndex = 0;
        let matchedItems = [];

        // Definición de Rutas y Acciones
        const APP_ROUTES = [
            // Dashboards & General
            {
                title: 'Dashboard',
                url: "{{ url_for('index') }}",
                icon: 'icon-[tabler--dashboard]',
                category: 'General'
            },
            {
                title: 'Directorio',
                url: "{{ url_for('directorio') }}",
                icon: 'icon-[tabler--users]',
                category: 'General'
            },

            // Cotizaciones
            {
                title: 'Cotizaciones',
                url: "{{ url_for('cotizaciones') }}",
                svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="size-5"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /><path d="M21 15h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5" /><path d="M19 21v1m0 -8v1" /></svg>`,
                category: 'Cotizaciones'
            },
            {
                title: 'Nueva Cotización',
                url: "{{ url_for('nueva_cotizacion') }}",
                icon: 'icon-[tabler--plus]',
                category: 'Cotizaciones'
            },

            // Órdenes
            {
                title: 'Órdenes de Trabajo',
                url: "{{ url_for('ordenes') }}",
                svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="size-5"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M7 10h3v-3l-3.5 -3.5a6 6 0 0 1 8 8l6 6a2 2 0 0 1 -3 3l-6 -6a6 6 0 0 1 -8 -8l3.5 3.5" /></svg>`,
                category: 'Órdenes'
            },

            // Tarificador
            {
                title: 'Tarificador',
                url: "{{ url_for('tarificador') }}",
                svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="size-5"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M5 21h14" /><path d="M6 18h2" /><path d="M7 18v3" /><path d="M9 11l3 3l6 -6l-3 -3l-6 6" /><path d="M10.5 12.5l-1.5 1.5" /><path d="M17 3l3 3" /><path d="M12 21a6 6 0 0 0 3.715 -10.712" /></svg>`,
                category: 'Laboratorio'
            },
            {
                title: 'Nuevo Tarificador',
                url: "{{ url_for('nuevo_tarificador') }}",
                icon: 'icon-[tabler--plus]',
                category: 'Laboratorio'
            },

            // Permisos
            {
                title: 'Permisos de Descarga',
                url: "{{ url_for('permisos_descarga') }}",
                svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="size-5"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M13.5 14.6l3 5.19a9 9 0 0 0 4.5 -7.79h-6a3 3 0 0 1 -1.5 2.6" /><path d="M13.5 9.4l3 -5.19a9 9 0 0 0 -9 0l3 5.19a3 3 0 0 1 3 0" /><path d="M10.5 14.6l-3 5.19a9 9 0 0 1 -4.5 -7.79h6a3 3 0 0 0 1.5 2.6" /></svg>`,
                category: 'Trámites'
            },

            // Consumos
            {
                title: 'Consumos de Agua',
                url: "{{ url_for('consumos') }}",
                svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="size-5"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M13.905 2.923l.098 .135l4.92 7.306a7.566 7.566 0 0 1 1.043 3.167l.024 .326c.007 .047 .01 .094 .01 .143l-.002 .06c.056 2.3 -.944 4.582 -2.87 6.14c-2.969 2.402 -7.286 2.402 -10.255 0c-1.904 -1.54 -2.904 -3.787 -2.865 -6.071a1.052 1.052 0 0 1 .013 -.333a7.66 7.66 0 0 1 .913 -3.176l.172 -.302l4.893 -7.26c.185 -.275 .426 -.509 .709 -.686c1.055 -.66 2.446 -.413 3.197 .55zm-2.06 1.107l-.077 .038l-.041 .03l-.037 .036l-.033 .042l-4.863 7.214a5.607 5.607 0 0 0 -.651 1.61h11.723a5.444 5.444 0 0 0 -.49 -1.313l-.141 -.251l-4.891 -7.261a.428 .428 0 0 0 -.5 -.145z" /></svg>`,
                category: 'H2O'
            },
        ];

        function toggleSearchModal(show) {
            if (!searchModal || !modalContent) return;

            if (show) {
                // Open Logic
                searchModal.classList.remove('invisible');
                searchModal.style.pointerEvents = 'auto'; // Re-enable pointer events

                // Force layout reflow
                void searchModal.offsetWidth;
                searchModal.classList.add('opacity-100');

                // Animate Content
                setTimeout(() => {
                    modalContent.classList.remove('opacity-0', 'scale-95');
                    modalContent.classList.add('opacity-100', 'scale-100');
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.focus();
                    }
                    renderResults('');
                }, 10);
            } else {
                // Close Logic
                modalContent.classList.remove('opacity-100', 'scale-100');
                modalContent.classList.add('opacity-0', 'scale-95');

                searchModal.classList.remove('opacity-100');

                setTimeout(() => {
                    searchModal.classList.add('invisible');
                    searchModal.style.pointerEvents = 'none';
                }, 300);
            }
        }

        function renderResults(query) {
            const q = query.toLowerCase();
            matchedItems = APP_ROUTES.filter(item =>
                item.title.toLowerCase().includes(q) ||
                item.category.toLowerCase().includes(q)
            );

            if (matchedItems.length === 0) {
                searchResults.innerHTML = `
                    <div class="p-8 text-center text-base-content/40">
                        <span class="icon-[tabler--search-off] size-8 mb-2 mx-auto block"></span>
                        <p class="text-sm">No se encontraron resultados para "${query}"</p>
                    </div>
                `;
                return;
            }

            // Agrupar por categoría
            const grouped = {};
            matchedItems.forEach(item => {
                if (!grouped[item.category]) grouped[item.category] = [];
                grouped[item.category].push(item);
            });

            let html = '';
            let globalIndex = 0;

            for (const [category, items] of Object.entries(grouped)) {
                html += `<div class="px-2 py-1.5 text-xs font-bold text-base-content/40 uppercase tracking-wider">${category}</div>`;
                items.forEach(item => {
                    const activeClass = globalIndex === selectedIndex ? 'bg-primary/10 text-primary border-primary/20' : 'hover:bg-base-200 border-transparent';
                    const iconClass = globalIndex === selectedIndex ? 'text-primary' : 'text-base-content/50';

                    // Determine Icon HTML
                    let iconHtml = '';
                    if (item.svg) {
                        // Inject class to control color
                        if (item.svg.includes('class="')) {
                            iconHtml = item.svg.replace('class="', `class="${iconClass} `);
                        } else {
                            // Fallback if no class attr
                            iconHtml = `<span class="${iconClass}">${item.svg}</span>`;
                        }
                    } else {
                        iconHtml = `<span class="${item.icon} size-5 ${iconClass}"></span>`;
                    }

                    html += `
                        <a href="${item.url}" 
                           class="flex items-center gap-3 px-3 py-3 rounded-lg mb-1 border transition-colors cursor-pointer ${activeClass}"
                           onmouseenter="setSelectedIndex(${globalIndex})">
                            ${iconHtml}
                            <span class="font-medium">${item.title}</span>
                            <span class="ml-auto text-xs opacity-40 hidden sm:block">Ir a página</span>
                        </a>
                    `;
                    globalIndex++;
                });
            }

            searchResults.innerHTML = html;
        }

        function setSelectedIndex(index) {
            selectedIndex = index;
            renderResults(searchInput.value);
        }

        // Global Keyboard Shortcut
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                toggleSearchModal(true);
            }

            // Check visibility via simplified logic - if opacity exists
            if (e.key === 'Escape' && searchModal.classList.contains('opacity-100')) {
                toggleSearchModal(false);
            }
        });

        // Search Input Navigation
        searchInput.addEventListener('input', (e) => {
            selectedIndex = 0;
            renderResults(e.target.value);
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, matchedItems.length - 1);
                renderResults(searchInput.value);
                // Scroll logic ideally goes here
                const activeEl = searchResults.children[selectedIndex]; // Rough approx
                if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                renderResults(searchInput.value);
                const activeEl = searchResults.children[selectedIndex]; // Rough approx
                if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (matchedItems.length > 0) {
                    window.location.href = matchedItems[selectedIndex].url;
                }
            }
        });
    </script>
</body>

</html>