{% extends 'base_flyonui.html' %}

{% block title %}{{ 'Detalle Consumo' if consumo else 'Registro de Consumo' }} - Sistema Cophi{% endblock %}

{% block content %}
<div class="w-full p-0 space-y-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <a href="{{ url_for('consumos') }}" class="btn btn-sm btn-ghost btn-circle" title="Volver">
                    <span class="icon-[tabler--arrow-left] size-5"></span>
                </a>
                <h1 class="text-3xl font-bold text-base-content">{{ 'Detalle Consumo' if consumo else 'Registro de
                    Consumo'
                    }}</h1>
            </div>
            <p class="text-base-content/60 font-medium ml-10">
                {{ 'Consulta y edita los detalles del consumo registrado.' if consumo else 'Complete el formulario para
                registrar una nueva lectura de medidor.' }}
            </p>
        </div>
        {% if consumo %}
        <div class="flex gap-2">
            <button type="button" class="btn btn-primary shadow-sm" onclick="enableEdit()" id="btn-editar">
                <span class="icon-[tabler--edit] size-5"></span>
                Editar
            </button>
        </div>
        {% endif %}
    </div>

    <form action="{{ url_for('guardar_consumo') }}" method="POST" class="flex flex-col gap-8 pb-20">
        <input type="hidden" name="original_folio" value="{{ consumo.folio if consumo else '' }}">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Tarjeta Identificación -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--id] size-5 text-primary"></span>
                    <span>Identificación del Registro</span>
                </div>
                <div class="card-body p-6 space-y-4">
                    <div class="form-control space-y-2">
                        <label
                            class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Folio</label>
                        <input type="text" id="folio" name="folio" placeholder="Ej. CON-001"
                            class="input input-bordered w-full h-10 font-bold text-primary"
                            value="{{ suggested_folio if not consumo else consumo.folio }}" required readonly>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Fecha
                                Registro</label>
                            <input type="date" id="fecha_registro" name="fecha_registro"
                                class="input input-bordered w-full h-10"
                                value="{{ consumo.fecha_registro if consumo else '' }}" {% if consumo %}disabled{% endif
                                %} required>
                        </div>
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Fecha
                                Lectura</label>
                            <input type="date" id="fecha_lectura" name="fecha_lectura"
                                class="input input-bordered w-full h-10"
                                value="{{ consumo.fecha_lectura if consumo else '' }}" {% if consumo %}disabled{% endif
                                %} required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tarjeta Cliente -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--user] size-5 text-secondary"></span>
                    <span>Asignación de Cliente</span>
                </div>
                <div class="card-body p-6 space-y-4">
                    <div class="form-control relative space-y-2">
                        <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Nombre
                            Cliente</label>
                        <input type="text" id="nombre_cliente" name="nombre_cliente" placeholder="Buscar cliente..."
                            class="input input-bordered w-full h-10" autocomplete="off" oninput="fillClient(this)"
                            required value="{{ consumo.nombre_cliente if consumo else '' }}" {% if consumo %}disabled{%
                            endif %}>
                        <div id="suggestions-box"
                            class="absolute z-50 w-full mt-1 bg-base-100 border border-base-content/10 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden">
                        </div>
                    </div>
                    <div class="form-control space-y-2">
                        <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">ID Cliente
                            / NIS</label>
                        <input type="text" id="ID_cliente" name="ID_cliente" placeholder="ID Cliente"
                            class="input input-bordered w-full h-10 font-mono text-secondary"
                            value="{{ consumo.ID_cliente if consumo else '' }}" readonly>
                    </div>
                </div>
            </div>

            <!-- Tarjeta Lectura -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden lg:col-span-2">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                    <span class="icon-[tabler--gauge] size-5 text-info"></span>
                    <span>Datos de Lectura de Medidor</span>
                </div>
                <div class="card-body p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                        <div class="form-control space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Lectura
                                Actual (m³)</label>
                            <input type="number" step="0.01" id="lectura" name="lectura" placeholder="0.00"
                                class="input input-bordered w-full h-10 font-black text-center text-xl"
                                value="{{ consumo.lectura if consumo else '' }}" {% if consumo %}disabled{% endif %}
                                required>
                        </div>

                        <div class="form-control space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Consumo
                                Calculado (m³)</label>
                            <div class="relative">
                                <input type="number" step="0.01" id="consumo" name="consumo" placeholder="---"
                                    class="input input-bordered w-full h-10 font-black text-center text-xl bg-base-200/50 border-dashed"
                                    value="{{ consumo.consumo if consumo else '' }}" readonly>
                            </div>
                            <p class="text-[10px] opacity-40 font-bold uppercase tracking-widest text-center mt-1">
                                Diferencia vs lectura anterior
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>

<div class="mt-8 flex justify-end gap-3 pb-20">
    <a href="{{ url_for('consumos') }}" class="btn btn-ghost h-10 min-h-0">Cancelar</a>
    <button type="submit" class="btn btn-primary btn-wide shadow-lg h-10 min-h-0 {% if consumo %}hidden{% endif %}"
        id="btn-submit">
        <span class="icon-[tabler--device-floppy] size-5"></span>
        Guardar Consumo
    </button>
</div>
</form>

<script id="clients-data" type="application/json">{{ clientes|tojson|safe }}</script>

<script>
    let clientsData = [];
    try {
        const dataEl = document.getElementById('clients-data');
        if (dataEl && dataEl.textContent) clientsData = JSON.parse(dataEl.textContent);
    } catch (e) {
        console.error("Error parsing clients data", e);
    }

    function normalizeStr(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    function fillClient(input) {
        const val = normalizeStr(input.value);
        const box = document.getElementById('suggestions-box');
        box.innerHTML = '';
        box.classList.add('hidden');

        if (!val) return;

        const matches = clientsData.filter(c => {
            const nombre = normalizeStr(c.nombre_empresa || '');
            const id = normalizeStr(c.ID || '');
            return nombre.includes(val) || id.includes(val);
        });

        if (matches.length > 0) {
            box.classList.remove('hidden');
            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-base-200 cursor-pointer border-b border-base-content/5 last:border-0';
                div.innerHTML = `<div class="font-bold text-sm">${match.nombre_empresa}</div><div class="text-xs opacity-60">${match.ID || ''}</div>`;
                div.onclick = () => {
                    document.getElementById('nombre_cliente').value = match.nombre_empresa;
                    document.getElementById('ID_cliente').value = match.ID || '';
                    box.classList.add('hidden');
                };
                box.appendChild(div);
            });
        }
    }

    document.addEventListener('click', (e) => {
        if (e.target.id !== 'nombre_cliente') document.getElementById('suggestions-box').classList.add('hidden');
    });

    function enableEdit() {
        document.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
        document.getElementById('folio').readOnly = true;
        document.getElementById('ID_cliente').readOnly = true;
        document.getElementById('consumo').readOnly = true;

        const btnSubmit = document.getElementById('btn-submit');
        if (btnSubmit) btnSubmit.classList.remove('hidden');
        const btnEdit = document.getElementById('btn-editar');
        if (btnEdit) btnEdit.classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const dateInput = document.getElementById('fecha_registro');
        if (dateInput && !dateInput.value) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    });
</script>
</div>
{% endblock %}