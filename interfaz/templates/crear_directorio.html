{% extends 'base_flyonui.html' %}

{% block title %}{{ 'Nuevo' if is_new else 'Detalle' }} {{ 'Cliente' if tipo == 'clientes' else 'Prospecto' }} - Sistema
Cophi{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
    <div>
        <div class="flex items-center gap-3 mb-1">
            <a href="{{ url_for('ver_directorio', tipo=tipo) }}"
                class="btn btn-sm btn-ghost btn-circle text-base-content/60" title="Volver">
                <span class="icon-[tabler--arrow-left] size-5"></span>
            </a>
            <h1 class="text-3xl font-bold text-base-content m-0">
                {{ 'Registro de' if is_new else 'Detalle de' }} {{ 'Cliente' if tipo == 'clientes' else 'Prospecto' }}
                {% if item.get('nombre_empresa') %}
                <span class="text-primary">: {{ item.get('nombre_empresa') }}</span>
                {% endif %}
            </h1>
        </div>
        <p class="text-base-content/60 font-medium ml-10">
            {% if item.get('nombre_empresa') %}
            Expediente de <span class="text-base-content font-bold">{{ item.get('nombre_empresa') }}</span> — {{
            'Gestión integral del perfil y documentos relacionados.' }}
            {% else %}
            {{ 'Complete el formulario para registrar una nueva entrada.' }}
            {% endif %}
        </p>
    </div>
    {% if not is_new %}
    <div class="flex gap-2">
        <button type="button" class="btn btn-primary shadow-sm" onclick="enableEdit()" id="btn-editar">
            <span class="icon-[tabler--edit] size-5"></span>
            Editar Datos
        </button>
    </div>
    {% endif %}
</div>

<!-- Menú de Navegación y Acciones (Solo visible en modo edición/detalle) -->
{% if not is_new %}
<div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden mb-6">
    <div class="card-body p-6 space-y-4">
        <h6 class="text-base-content/70 font-semibold mb-0">Sección:</h6>
        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
            <div class="input max-w-xl items-center pe-0">
                <select id="tab-selector" class="select select-sm w-full md:w-auto min-w-[200px]"
                    aria-label="Seleccionar sección" onchange="showTab(this.value)">
                    <option value="general" selected>Información General</option>
                    <option value="cotizaciones">Cotizaciones</option>
                    <option value="ordenes">Órdenes de Trabajo</option>
                    <option value="tarificador">Análisis de Laboratorio</option>
                    <option value="permisos">Permisos de Descarga</option>
                    <option value="consumos">Consumos de Agua</option>
                </select>
            </div>
            <!-- Acciones Dinámicas según Tab -->
            <div id="tab-actions" class="flex gap-3">
                <!-- Se llenará con JS -->
            </div>
        </div>

    </div>
</div>
{% endif %}

<!-- SECCIONES DE CONTENIDO -->


<div class="space-y-8 pb-20">

    <!-- PESTAÑA 1: INFORMACIÓN GENERAL -->
    <div id="tab-general" class="tab-content transition-all duration-300">
        <form action="{{ url_for('guardar_directorio', tipo=tipo) }}" method="POST">
            {% if not is_new %}
            {% if tipo == 'clientes' %}
            <input type="hidden" name="ID" value="{{ item.get('ID', '') }}">
            {% else %}
            <input type="hidden" name="folio" value="{{ item.get('folio', '') }}">
            {% endif %}
            {% endif %}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Tarjeta: Registro (Folio y Fecha) -->
                <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden lg:col-span-2">
                    <div
                        class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                        <span class="icon-[tabler--tag] size-5 text-primary"></span>
                        <span>Información del Registro</span>
                    </div>
                    <div class="card-body p-6 flex flex-col md:flex-row gap-6">
                        <div class="form-control flex-1 space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Folio</label>
                            <input type="text" name="folio"
                                value="{{ (item.get('folio') if item else suggested_folio) or suggested_folio or '' }}"
                                required class="input input-bordered w-full font-black text-primary always-locked"
                                readonly>
                        </div>
                        <div class="form-control flex-1 space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Fecha
                                de
                                Registro</label>
                            <input type="text" name="fecha_creacion"
                                value="{{ (item.get('fecha_creacion') if item else todays_date) or todays_date or '' }}"
                                class="input input-bordered w-full always-locked" readonly>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta Principal: Identificación -->
                <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                    <div
                        class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                        <span class="icon-[tabler--id] size-5 text-primary"></span>
                        <span>Identificación y Contacto</span>
                    </div>
                    <div class="card-body p-6 space-y-4">
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Nombre
                                Empresa</label>
                            <input type="text" name="nombre_empresa" value="{{ item.get('nombre_empresa', '') }}"
                                required class="input input-bordered w-full font-black text-primary" {% if not is_new
                                %}disabled{% endif %} placeholder="Ej. Abarrotes Don Pepe">
                        </div>
                        <div class="form-control space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Propietario
                                /
                                Representante Legal</label>
                            <input type="text" name="propietario_empresa"
                                value="{{ item.get('propietario_empresa', '') }}" class="input input-bordered w-full" {%
                                if not is_new %}disabled{% endif %}
                                placeholder="Nombre del dueño o representante legal">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">RFC
                                    Propietario / Representante Legal</label>
                                <input type="text" name="rfc_propietario" value="{{ item.get('rfc_propietario', '') }}"
                                    class="input input-bordered w-full font-mono uppercase" {% if not is_new
                                    %}disabled{% endif %} placeholder="RFC del Propietario">
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">RFC
                                    Empresa</label>
                                <input type="text" name="rfc_empresa" value="{{ item.get('rfc_empresa', '') }}"
                                    class="input input-bordered w-full font-mono uppercase" {% if not is_new
                                    %}disabled{% endif %} placeholder="RFC de la Empresa">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Tipo
                                    de Empresa</label>
                                <div class="w-full">
                                    <select name="tipo_empresa" data-select='{
                                    "placeholder": "Selecciona opción...",
                                    "toggleTag": "<button type=\"button\" aria-expanded=\"false\"></button>",
                                    "toggleClasses": "advance-select-toggle relative select-disabled:pointer-events-none select-disabled:opacity-40",
                                    "dropdownClasses": "advance-select-menu max-h-52 overflow-y-auto",
                                    "optionClasses": "advance-select-option selected:select-active",
                                    "optionTemplate": "<div class=\"flex justify-between items-center w-full\"><span data-title></span><span class=\"icon-[tabler--check] shrink-0 size-4 text-primary hidden selected:block \"></span></div>",
                                    "extraMarkup": "<span class=\"icon-[tabler--caret-up-down] shrink-0 size-4 text-base-content absolute top-1/2 end-3 -translate-y-1/2 pointer-events-none\"></span>"
                                    }' class="hidden" {% if not is_new %}disabled{% endif %}>
                                        <option value="">Selecciona</option>
                                        {% set opciones_giro = ['Restaurante', 'Plaza comercial', 'Torre Comercial',
                                        'Industria', 'Escuela', 'Local Comercial'] %}
                                        {% for opt in opciones_giro %}
                                        <option value="{{ opt }}" {% if item.get('tipo_empresa')==opt %}selected{% endif
                                            %}>{{ opt }}</option>
                                        {% endfor %}
                                        {% if item.get('tipo_empresa') and item.get('tipo_empresa') not in opciones_giro
                                        %}
                                        <option value="{{ item.get('tipo_empresa') }}" selected>{{
                                            item.get('tipo_empresa') }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Teléfono</label>
                                <input type="text" name="telefono_empresa"
                                    value="{{ item.get('telefono_empresa', '') }}" class="input input-bordered w-full"
                                    {% if not is_new %}disabled{% endif %} placeholder="Ej. 55 1234 5678">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Calle
                                    y
                                    Número</label>
                                <input type="text" name="calle_num_empresa"
                                    value="{{ item.get('calle_num_empresa', '') }}" class="input input-bordered w-full"
                                    {% if not is_new %}disabled{% endif %} placeholder="Ej. Av. Reforma 123">
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Colonia</label>
                                <input type="text" name="colonia_empresa" value="{{ item.get('colonia_empresa', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                    placeholder="Ej. Centro">
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">C.P.</label>
                                <input type="text" name="cp_empresa" value="{{ item.get('cp_empresa', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                    placeholder="Ej. 72000">
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Municipio</label>
                                <input type="text" name="municipio_empresa"
                                    value="{{ item.get('municipio_empresa', '') }}" class="input input-bordered w-full"
                                    {% if not is_new %}disabled{% endif %} placeholder="Ej. Puebla">
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Localidad</label>
                                <input type="text" name="localidad_empresa"
                                    value="{{ item.get('localidad_empresa', '') }}" class="input input-bordered w-full"
                                    {% if not is_new %}disabled{% endif %} placeholder="Ej. San Baltazar">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta: Datos de Servicio y Contratación (Ambos) -->
                <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                    <div
                        class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                        <span class="icon-[tabler--address-book] size-5 text-primary"></span>
                        <span>Datos de Servicio y Contrato de Agua</span>
                    </div>
                    <div class="card-body p-6 space-y-4">
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Nombre
                                del Usuario</label>
                            <input type="text" name="nombre_usuario" value="{{ item.get('nombre_usuario', '') }}"
                                class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                placeholder="Según datos en boleta de agua">
                        </div>
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">NIS
                                (Contrato Agua)</label>
                            <input type="text" name="nis" value="{{ item.get('nis', '') }}"
                                class="input input-bordered w-full font-mono text-primary" {% if not is_new %}disabled{%
                                endif %} placeholder="Según datos en boleta de agua">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Titular
                                    de Pago</label>
                                <input type="text" name="titular_pago" value="{{ item.get('titular_pago', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                    placeholder="Según datos en boleta de agua">
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Régimen</label>
                                <input type="text" name="regimen" value="{{ item.get('regimen', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                    placeholder="Según datos en boleta de agua">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Giro</label>
                                <input type="text" name="giro" value="{{ item.get('giro', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                    placeholder="Según datos en boleta de agua">
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Uso</label>
                                <input type="text" name="uso" value="{{ item.get('uso', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                    placeholder="Según datos en boleta de agua">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Día
                                    de corte</label>
                                <input type="text" name="corte_servicio" value="{{ item.get('corte_servicio', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                    placeholder="Según datos en boleta de agua">
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Contrato
                                    con</label>
                                <div class="w-full">
                                    <select name="contrato_con" data-select='{
                                        "placeholder": "Selecciona opción...",
                                        "toggleTag": "<button type=\"button\" aria-expanded=\"false\"></button>",
                                        "toggleClasses": "advance-select-toggle relative select-disabled:pointer-events-none select-disabled:opacity-40",
                                        "dropdownClasses": "advance-select-menu max-h-52 overflow-y-auto",
                                        "optionClasses": "advance-select-option selected:select-active",
                                        "optionTemplate": "<div class=\"flex justify-between items-center w-full\"><span data-title></span><span class=\"icon-[tabler--check] shrink-0 size-4 text-primary hidden selected:block \"></span></div>",
                                        "extraMarkup": "<span class=\"icon-[tabler--caret-up-down] shrink-0 size-4 text-base-content absolute top-1/2 end-3 -translate-y-1/2 pointer-events-none\"></span>"
                                        }' class="hidden" {% if not is_new %}disabled{% endif %}>
                                        <option value="">Selecciona</option>
                                        {% set opciones_contrato = ['Agua de Puebla', 'Plaza comercial'] %}
                                        {% for opt in opciones_contrato %}
                                        <option value="{{ opt }}" {% if item.get('contrato_con')==opt %}selected{% endif
                                            %}>{{ opt }}</option>
                                        {% endfor %}
                                        {% if item.get('contrato_con') and item.get('contrato_con') not in
                                        opciones_contrato %}
                                        <option value="{{ item.get('contrato_con') }}" selected>{{
                                            item.get('contrato_con') }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-control space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Tarifa</label>
                            <input type="text" name="tarifa" value="{{ item.get('tarifa', '') }}"
                                class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                placeholder="Según datos en boleta de agua">
                        </div>
                    </div>
                </div>

                {% if tipo == 'clientes' %}
                <!-- Tarjeta: Datos Fiscales (Solo Clientes) -->
                <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                    <div
                        class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                        <span class="icon-[tabler--receipt-tax] size-5 text-secondary"></span>
                        <span>Datos Fiscales y Contrato</span>
                    </div>
                    <div class="card-body p-6 space-y-4">
                        <div class="form-control space-y-2">
                            <label class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Razón
                                Social</label>
                            <input type="text" name="razon_social" value="{{ item.get('razon_social', '') }}"
                                class="input input-bordered w-full font-bold text-secondary" {% if not is_new
                                %}disabled{% endif %} placeholder="Razón Social Completa">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Giro
                                    Licencia</label>
                                <input type="text" name="giro_licencia" value="{{ item.get('giro_licencia', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}>
                            </div>

                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">No.
                                    Permiso
                                    Descargas</label>
                                <input type="text" name="no_permiso_descargas"
                                    value="{{ item.get('no_permiso_descargas', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}>
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Vigencia
                                    Permiso</label>
                                <input type="text" name="vegencia_permiso_descargas"
                                    value="{{ item.get('vegencia_permiso_descargas', '') }}"
                                    class="input input-bordered w-full" placeholder="dd/mm/aaaa" {% if not is_new
                                    %}disabled{% endif %}>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta: Servicios e Infraestructura (Solo Clientes) -->
                <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                    <div
                        class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex items-center gap-2 uppercase tracking-widest text-xs">
                        <span class="icon-[tabler--tool] size-5 text-info"></span>
                        <span>Infraestructura Hidráulica y Servicios</span>
                    </div>
                    <div class="card-body p-6 space-y-8">
                        <!-- Almacenamiento -->
                        <div class="space-y-4">
                            <h4
                                class="text-xs font-black uppercase text-base-content/40 border-b border-base-content/5 pb-2">
                                Almacenamiento</h4>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Cisternas
                                    (No. / Cap.)</label>
                                <div class="flex gap-2">
                                    <input type="text" name="total_cisternas"
                                        value="{{ item.get('total_cisternas', '') }}" class="input input-bordered w-1/3"
                                        placeholder="No." {% if not is_new %}disabled{% endif %}>
                                    <input type="text" name="cap_cisternas" value="{{ item.get('cap_cisternas', '') }}"
                                        class="input input-bordered w-2/3" placeholder="Liters" {% if not is_new
                                        %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Tinacos
                                    (No. / Cap.)</label>
                                <div class="flex gap-2">
                                    <input type="text" name="total_tinacos" value="{{ item.get('total_tinacos', '') }}"
                                        class="input input-bordered w-1/3" placeholder="No." {% if not is_new
                                        %}disabled{% endif %}>
                                    <input type="text" name="cap_tinacos" value="{{ item.get('cap_tinacos', '') }}"
                                        class="input input-bordered w-2/3" placeholder="Liters" {% if not is_new
                                        %}disabled{% endif %}>
                                </div>
                            </div>
                        </div>

                        <!-- Muebles Sanitarios -->
                        <div class="space-y-4">
                            <h4
                                class="text-xs font-black uppercase text-base-content/40 border-b border-base-content/5 pb-2">
                                Muebles Sanitarios</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="form-control space-y-2">
                                    <label
                                        class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">No.
                                        W.C.</label>
                                    <input type="number" name="no_wc" value="{{ item.get('no_wc', '') }}"
                                        class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}>
                                </div>
                                <div class="form-control space-y-2">
                                    <label
                                        class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">No.
                                        Mingitorios</label>
                                    <input type="number" name="no_mingitorios"
                                        value="{{ item.get('no_mingitorios', '') }}" class="input input-bordered w-full"
                                        {% if not is_new %}disabled{% endif %}>
                                </div>
                                <div class="form-control space-y-2">
                                    <label
                                        class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">No.
                                        Lavamanos</label>
                                    <input type="number" name="no_lavamanos" value="{{ item.get('no_lavamanos', '') }}"
                                        class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}>
                                </div>
                                <div class="form-control space-y-2">
                                    <label
                                        class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">No.
                                        Regaderas</label>
                                    <input type="number" name="no_regaderas" value="{{ item.get('no_regaderas', '') }}"
                                        class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}>
                                </div>
                            </div>
                        </div>
                        <!-- Abastecimiento -->
                        <div class="space-y-4">
                            <h4
                                class="text-xs font-black uppercase text-base-content/40 border-b border-base-content/5 pb-2">
                                Abastecimiento</h4>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Pozo
                                    (Si-No / No. Conc)</label>
                                <div class="flex gap-2">
                                    <input type="text" name="pozo" value="{{ item.get('pozo', '') }}"
                                        class="input input-bordered w-1/3" placeholder="S/N" {% if not is_new
                                        %}disabled{% endif %}>
                                    <input type="text" name="num_concesion_pozo"
                                        value="{{ item.get('num_concesion_pozo', '') }}"
                                        class="input input-bordered w-2/3" placeholder="Concesión" {% if not is_new
                                        %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Tomas
                                    /
                                    Red (No. / Red)</label>
                                <div class="flex gap-2">
                                    <input type="text" name="num_tomas" value="{{ item.get('num_tomas', '') }}"
                                        class="input input-bordered w-1/3" placeholder="No." {% if not is_new
                                        %}disabled{% endif %}>
                                    <input type="text" name="red" value="{{ item.get('red', '') }}"
                                        class="input input-bordered w-2/3" placeholder="Municipal?" {% if not is_new
                                        %}disabled{% endif %}>
                                </div>
                            </div>
                        </div>

                        <!-- Pipas y Medidor -->
                        <div class="space-y-4">
                            <h4
                                class="text-xs font-black uppercase text-base-content/40 border-b border-base-content/5 pb-2">
                                Pipas y Medidor</h4>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Pipas
                                    (Prom. / Cap.)</label>
                                <div class="flex gap-2">
                                    <input type="text" name="prom_pipas_mes"
                                        value="{{ item.get('prom_pipas_mes', '') }}" class="input input-bordered w-1/2"
                                        placeholder="Mes" {% if not is_new %}disabled{% endif %}>
                                    <input type="text" name="capacidad_pipas"
                                        value="{{ item.get('capacidad_pipas', '') }}" class="input input-bordered w-1/2"
                                        placeholder="Cap." {% if not is_new %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Medidor
                                    (S-N / Serie)</label>
                                <div class="flex gap-2">
                                    <input type="text" name="medidor_agua " value="{{ item.get('medidor_agua ', '') }}"
                                        class="input input-bordered w-1/3" placeholder="S/N" {% if not is_new
                                        %}disabled{% endif %}>
                                    <input type="text" name="no_serie_medidor"
                                        value="{{ item.get('no_serie_medidor', '') }}"
                                        class="input input-bordered w-2/3" placeholder="Serie" {% if not is_new
                                        %}disabled{% endif %}>
                                </div>
                            </div>
                        </div>

                        <!-- Descargas -->
                        <div class="space-y-4">
                            <h4
                                class="text-xs font-black uppercase text-base-content/40 border-b border-base-content/5 pb-2">
                                Descargas</h4>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Registro
                                    (S-N / Loc.)</label>
                                <div class="flex gap-2">
                                    <input type="text" name="tiene_registro"
                                        value="{{ item.get('tiene_registro', '') }}" class="input input-bordered w-1/3"
                                        placeholder="S/N" {% if not is_new %}disabled{% endif %}>
                                    <input type="text" name="localización_registro"
                                        value="{{ item.get('localización_registro', '') }}"
                                        class="input input-bordered w-2/3" placeholder="Ubicación" {% if not is_new
                                        %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="form-control space-y-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Trampas
                                    (No. / Cap.)</label>
                                <div class="flex gap-2">
                                    <input type="text" name="no_trampas_grasa"
                                        value="{{ item.get('no_trampas_grasa', '') }}"
                                        class="input input-bordered w-1/3" placeholder="No." {% if not is_new
                                        %}disabled{% endif %}>
                                    <input type="text" name="cap_trampas" value="{{ item.get('cap_trampas', '') }}"
                                        class="input input-bordered w-2/3" placeholder="Cap." {% if not is_new
                                        %}disabled{% endif %}>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="mt-8 flex justify-end gap-3 pb-10">
                <a href="{{ url_for('ver_directorio', tipo=tipo) }}" class="btn btn-ghost">Cancelar</a>
                <button type="submit" class="btn btn-primary btn-wide shadow-lg {% if not is_new %}hidden{% endif %}"
                    id="btn-submit">
                    <span class="icon-[tabler--device-floppy] size-5"></span>
                    {{ 'Guardar Registro' if is_new else 'Guardar Cambios' }}
                </button>
            </div>
        </form>
    </div>

    {% if not is_new %}
    <!-- PESTAÑA 2: COTIZACIONES -->
    <div id="tab-cotizaciones" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">
        <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
            <div
                class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex justify-between items-center uppercase tracking-widest text-xs">
                <span>Historial de Cotizaciones</span>
            </div>
            <div class="card-body p-0">
                <div class="overflow-x-auto">
                    <table class="table table-lg">
                        <thead class="bg-base-200/30">
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th class="text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-base-content/5">
                            {% for data in cotizaciones %}
                            <tr class="hover:bg-base-200/30">
                                <td><span class="font-bold text-primary">{{ data.folio_cot }}</span></td>
                                <td class="text-base-content/60">{{ data.fecha_cot }}</td>
                                <td class="font-black text-base-content">${{ data.total }}</td>
                                <td class="text-right">
                                    <a href="{{ url_for('detalle_cotizacion', folio=data.folio_cot) }}"
                                        class="btn btn-soft btn-secondary btn-sm">Ver</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-10 opacity-40">Sin cotizaciones registradas.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 3: ORDENES -->
    <div id="tab-ordenes" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Desazolves -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-4 font-bold uppercase tracking-widest text-xs">
                    Desazolves</div>
                <div class="card-body p-0 max-h-96 overflow-y-auto">
                    <table class="table table-sm">
                        <tbody class="divide-y divide-base-content/5">
                            {% for o in ordenes_des|reverse %}
                            <tr class="hover:bg-base-200/30">
                                <td>
                                    <div class="font-bold text-primary">{{ o.folio_des }}</div>
                                    <div class="text-[10px] opacity-60">{{ o.fecha_des }}</div>
                                </td>
                                <td class="text-right"><a
                                        href="{{ url_for('detalle_orden', tipo='desazolve', folio=o.folio_des) }}"
                                        class="btn btn-link btn-xs">Ver</a></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td class="text-center py-4 opacity-40">Vacío</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Trampas -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-4 font-bold uppercase tracking-widest text-xs">
                    Trampas Grasa
                </div>
                <div class="card-body p-0 max-h-96 overflow-y-auto">
                    <table class="table table-sm">
                        <tbody class="divide-y divide-base-content/5">
                            {% for o in ordenes_trampa|reverse %}
                            <tr class="hover:bg-base-200/30">
                                <td>
                                    <div class="font-bold text-primary">{{ o.folio_lt }}</div>
                                    <div class="text-[10px] opacity-60">{{ o.fecha_lt }}</div>
                                </td>
                                <td class="text-right"><a
                                        href="{{ url_for('detalle_orden', tipo='trampa', folio=o.folio_lt) }}"
                                        class="btn btn-link btn-xs">Ver</a></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td class="text-center py-4 opacity-40">Vacío</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Visitas -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                <div
                    class="card-header bg-base-200/50 border-b border-base-content/10 p-4 font-bold uppercase tracking-widest text-xs">
                    Visitas Técnicas
                </div>
                <div class="card-body p-0 max-h-96 overflow-y-auto">
                    <table class="table table-sm">
                        <tbody class="divide-y divide-base-content/5">
                            {% for o in ordenes_visita|reverse %}
                            <tr class="hover:bg-base-200/30">
                                <td>
                                    <div class="font-bold text-primary">{{ o.folio_vt }}</div>
                                    <div class="text-[10px] opacity-60">{{ o.fecha_vt }}</div>
                                </td>
                                <td class="text-right"><a
                                        href="{{ url_for('detalle_orden', tipo='visita', folio=o.folio_vt) }}"
                                        class="btn btn-link btn-xs">Ver</a></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td class="text-center py-4 opacity-40">Vacío</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 4: TARIFICADOR -->
    <div id="tab-tarificador" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Tarjeta de Precios (Último Tarificador) -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm h-full">
                <div class="card-body p-6 relative flex flex-col">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-4 border-b pb-2"
                        style="border-color: rgba(0, 153, 207, 0.1);">
                        <h4 class="text-xs font-black uppercase tracking-widest" style="color: #0099cf;">
                            Tarifa de Saneamiento
                        </h4>
                        {% set latest_tar = tarificadores[0] if tarificadores else None %}
                        <div class="flex items-center gap-2">
                            <span class="status animate-pulse" style="background-color: #0099cf;"></span>
                            <span class="text-[10px] font-bold text-base-content/60 uppercase">
                                {{ latest_tar.fecha_tar if latest_tar else '---' }}
                            </span>
                        </div>
                    </div>

                    {% if latest_tar %}
                    <div class="space-y-2 text-xs overflow-y-auto pr-1 custom-scrollbar flex-grow max-h-48">
                        <!-- Headers -->
                        <div
                            class="flex justify-between border-b border-base-content/10 pb-1 font-bold uppercase text-base-content/40 tracking-tighter">
                            <span class="w-1/4">Parám.</span>
                            <span class="w-1/4 text-center">Res.</span>
                            <span class="w-1/4 text-center">LMP</span>
                            <span class="w-1/4 text-right">Precio</span>
                        </div>

                        {% set prefixes = [
                        ('SST', 'sst'), ('DBO', 'dbo'), ('GyA', 'gya'),
                        ('SS', 'ss'), ('MF', 'mf'), ('Temp', 'temp'),
                        ('SAAM', 'saam'), ('DQO', 'dqo'), ('NT', 'nt'),
                        ('Fen', 'fen'), ('Color', 'color')
                        ] %}
                        {% set has_params = false %}
                        {% for label, pre in prefixes %}
                        {% set p_key = pre ~ '_precio' %}
                        {% set r_key = pre ~ '_resultado' %}
                        {% set l_key = pre ~ '_lmp' %}

                        {% set price = latest_tar.get(p_key, '$0.00') %}
                        {% if price and price != '$0.00' and price != '0.00' and price != '' %}
                        {% set has_params = true %}
                        <div
                            class="flex justify-between items-center border-b border-base-content/5 pb-1 last:border-0">
                            <span class="w-1/4 text-base-content/70 font-semibold">{{ label }}</span>
                            <span class="w-1/4 text-center font-mono">{{ latest_tar.get(r_key, '-') }}</span>
                            <span class="w-1/4 text-center text-base-content/50 font-mono">{{ latest_tar.get(l_key, '-')
                                }}</span>
                            <span class="w-1/4 text-right font-mono font-bold">{{ price }}</span>
                        </div>
                        {% endif %}
                        {% endfor %}

                        {% if not has_params %}
                        <div class="text-center py-4 italic opacity-50">Sin cargos extra detectados.</div>
                        {% endif %}
                    </div>
                    <div class="pt-3 mt-auto border-t-2 border-base-content/10 flex justify-between items-end">
                        <span class="text-xs font-bold text-base-content/50 uppercase">Total / m³</span>
                        <span class="text-xl font-black" style="color: #0099cf;">${{ latest_tar.get('precio_m3_total',
                            '0.00') }}</span>
                    </div>
                    {% else %}
                    <div
                        class="flex flex-col items-center justify-center h-full opacity-30 italic text-sm text-center py-8">
                        <span class="icon-[tabler--flask-off] size-10 mb-2"></span>
                        Sin registros de laboratorio.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Filtros Tab Tarificador -->
            <div class="lg:col-span-2 card bg-base-100 border border-base-content/10 shadow-sm h-full">
                <div class="card-body p-6">
                    <form method="GET"
                        action="{{ url_for('detalle_directorio', tipo=tipo, id_val=item.get('folio') or item.get('id_cliente')) }}"
                        class="space-y-6 w-full">
                        <input type="hidden" name="tab" value="tarificador">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Búsqueda General -->
                            <div class="form-control md:col-span-2">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Búsqueda</label>
                                <input type="text" name="t_search" class="input input-bordered w-full h-10"
                                    placeholder="Buscar por folio..." value="{{ request.args.get('t_search', '') }}">
                            </div>

                            <!-- Año -->
                            <div class="form-control">
                                <label
                                    class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Año</label>
                                <select name="t_anio" class="select select-bordered w-full h-10 min-h-0 px-3">
                                    <option value="">Todos</option>
                                    {% for y in range(2024, 2031) %}
                                    <option value="{{ y }}" {% if request.args.get('t_anio')==y|string %}selected{%
                                        endif %}>{{ y }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Botones -->
                            <div class="flex gap-3 items-end">
                                <button type="submit"
                                    class="btn btn-primary h-10 min-h-0 px-6 flex items-center gap-2 w-full">
                                    <span class="icon-[tabler--search] size-5"></span>
                                    <span>Buscar</span>
                                </button>
                                <a href="{{ url_for('detalle_directorio', tipo=tipo, id_val=item.get('folio') or item.get('id_cliente')) }}?tab=tarificador"
                                    class="btn btn-soft btn-secondary h-10 min-h-0 btn-square" title="Limpiar">
                                    <span class="icon-[tabler--filter-x] size-5"></span>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
            <div class="card-body p-0">
                <table class="table table-lg">
                    <thead class="bg-base-200/30">
                        <tr>
                            <th>Folio</th>
                            <th>Fecha</th>
                            <th>Precio m3</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-base-content/5">
                        {% for d in tarificadores %}
                        <tr class="hover:bg-base-200/30">
                            <td><span class="font-bold text-primary">{{ d.folio_tar }}</span></td>
                            <td class="text-base-content/60">{{ d.fecha_tar }}</td>
                            <td class="font-black text-success">${{ d.precio_m3_total }}</td>
                            <td class="text-right"><a href="{{ url_for('detalle_tarificador', folio=d.folio_tar) }}"
                                    class="btn btn-soft btn-secondary btn-sm">Ver</a></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-10 opacity-40">Sin reportes aún.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 5: PERMISOS -->
    <div id="tab-permisos" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">
        <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
            <div class="card-body p-0">
                <table class="table table-lg">
                    <thead class="bg-base-200/30">
                        <tr>
                            <th>NIS</th>
                            <th>Interesado</th>
                            <th>Fecha</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-base-content/5">
                        {% for p in permisos %}
                        <tr class="hover:bg-base-200/30">
                            <td><span class="font-mono font-bold text-secondary">{{ p.nis }}</span></td>
                            <td>
                                <div class="font-medium">{{ p.arr_nombre or p.prop_nombre }}</div>
                            </td>
                            <td class="text-base-content/60">{{ p.fecha_acuse }}</td>
                            <td class="text-right"><a href="{{ url_for('detalle_permiso_descarga', nis=p.nis) }}"
                                    class="btn btn-soft btn-secondary btn-sm">Ver</a></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-10 opacity-40">No hay permisos de descarga.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 6: CONSUMOS -->
    <div id="tab-consumos" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Tarifas -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm">
                <div class="card-body p-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-2"
                        style="border-color: rgba(0, 153, 207, 0.1);">
                        <h4 class="text-xs font-black uppercase tracking-widest" style="color: #0099cf;">
                            Tarifa Actual (Mensual)
                        </h4>
                        <div class="flex items-center gap-2">
                            <span class="status animate-pulse" style="background-color: #0099cf;"></span>
                            <span class="text-[10px] font-bold text-base-content/60 uppercase">Hoy: {{
                                total_period_actual }} m³</span>
                        </div>
                    </div>
                    {% if current_tariff %}
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm"><span>Agua:</span><span class="font-bold">${{
                                current_tariff.tarifa_agua }}</span></div>
                        <div class="flex justify-between text-sm"><span>Drenaje:</span><span class="font-bold">${{
                                current_tariff.tarifa_drenaje }}</span></div>
                        <div class="flex justify-between text-sm"><span>Saneamiento:</span><span class="font-bold">${{
                                current_tariff.tarifa_saneamiento }}</span></div>
                        <div class="pt-2 border-t border-base-content/5 flex justify-between text-lg font-black"
                            style="color: #0099cf;">
                            <span>Total:</span><span>${{ current_tariff.total_tarifa }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4 opacity-30 italic text-sm">Sin datos de tarifa.</div>
                    {% endif %}
                </div>
            </div>

            <!-- Nivel Consumo -->
            <div class="lg:col-span-2 card bg-base-100 border border-base-content/10 shadow-sm">
                <div class="card-body p-6 relative">
                    <!-- Header con Filtros -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                        <div>
                            <h4 class="text-xs font-black uppercase tracking-widest text-base-content/40 mb-1">Monitor
                                de Consumo</h4>
                            <div class="text-xs opacity-60">
                                Periodo: <span class="font-bold">{{ period_start_date }}</span> (Corte día {{
                                item.get('corte_servicio', '1') }})
                            </div>
                        </div>
                        <!-- Tag for JS initialization -->
                        <div id="filter-status" data-has-filter="{{ 'true' if q_anio or q_mes else 'false' }}"></div>
                    </div>

                    <!-- Acordeón de Tarifas (FlyonUI) -->
                    <div class="accordion divide-neutral/20 divide-y mb-6 w-full">
                        <div class="accordion-item group" id="tarifa-info">
                            <button
                                class="accordion-toggle inline-flex items-center gap-x-2 text-start w-full py-2 font-black text-[10px] uppercase tracking-widest text-[#0099cf] hover:text-[#007aa6] transition-colors"
                                aria-controls="tarifa-info-collapse" aria-expanded="false" onclick="
                                    const c = document.getElementById('tarifa-info-collapse');
                                    c.classList.toggle('hidden');
                                    this.setAttribute('aria-expanded', !c.classList.contains('hidden'));
                                    this.querySelector('.plus').classList.toggle('hidden');
                                    this.querySelector('.minus').classList.toggle('hidden');">
                                <span class="icon-[tabler--plus] plus size-4 block shrink-0"></span>
                                <span class="icon-[tabler--minus] minus size-4 hidden shrink-0"></span>
                                Ver Tarifas Oficiales Vigentes
                            </button>
                            <div id="tarifa-info-collapse"
                                class="accordion-content hidden w-full overflow-hidden transition-all duration-300"
                                aria-labelledby="tarifa-info" role="region">
                                <div class="pb-4 pt-2">
                                    <div class="overflow-x-auto rounded-lg border border-base-content/5">
                                        <table class="table table-xs w-full bg-base-100">
                                            <thead
                                                class="bg-base-200/50 text-base-content/60 font-bold uppercase tracking-wider">
                                                <tr>
                                                    <th class="py-2 px-3">Rango (m³)</th>
                                                    <th class="text-right py-2 px-3">Agua</th>
                                                    <th class="text-right py-2 px-3">Drenaje</th>
                                                    <th class="text-right py-2 px-3">Saneamiento</th>
                                                    <th class="text-right font-black py-2 px-3 text-base-content">Total
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody class="text-xs divide-y divide-base-content/5">
                                                {% for r in rangos_list %}
                                                <tr class="hover:bg-base-200/20">
                                                    <td
                                                        class="font-bold whitespace-nowrap px-3 py-2 text-base-content/70">
                                                        {{ r.get('minimo') }} - {{ r.get('maximo') }}</td>
                                                    <td class="text-right px-3 py-2 opacity-80">${{ r.get('tarifa_agua')
                                                        }}</td>
                                                    <td class="text-right px-3 py-2 opacity-80">${{
                                                        r.get('tarifa_drenaje') }}</td>
                                                    <td class="text-right px-3 py-2 opacity-80">${{
                                                        r.get('tarifa_saneamiento') }}</td>
                                                    <td class="text-right font-black px-3 py-2 text-[#0099cf]">${{
                                                        r.get('total_tarifa') }}</td>
                                                </tr>
                                                {% else %}
                                                <tr>
                                                    <td colspan="5" class="text-center py-4 italic opacity-50">No hay
                                                        información de tarifas disponible.</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Barra de Progreso Continua (Estilos Inline para Robustez) -->
                    <div class="mt-8 mb-8 w-full select-none" style="position: relative;">

                        <!-- Rótulos Superiores -->
                        <div
                            class="flex justify-between text-[10px] font-bold text-base-content/40 uppercase tracking-widest mb-2 px-1">
                            <span style="width: 0;"></span>
                            <span style="width: 20%; text-align: center;">Tarifa 1</span>
                            <span style="width: 20%; text-align: center;">Tarifa 2</span>
                            <span style="width: 20%; text-align: center;">Tarifa 3</span>
                            <span style="width: 20%; text-align: center;">Tarifa 4</span>
                            <span style="width: 20%; text-align: right;">Mayor</span>
                        </div>

                        {% set total = total_period_actual|default(0)|float %}
                        <!-- Cálculo seguro de porcentaje -->
                        {% set porcentaje = (total / 100.0 * 100.0) %}
                        {% if porcentaje > 100 %}{% set porcentaje = 100 %}{% endif %}
                        {% if porcentaje < 0 %}{% set porcentaje=0 %}{% endif %} <!-- Contenedor de la Barra (Track) -->
                            <div
                                style="position: relative; height: 16px; width: 100%; background-color: #e5e7eb; border-radius: 9999px; margin-top: 10px; margin-bottom: 30px;">

                                <!-- Barra de Relleno (Fill) -->
                                <div
                                    style="position: absolute; top: 0; left: 0; height: 100%; background-color: #0099cf; border-radius: 9999px; width: {{ porcentaje }}%; transition: width 0.5s ease-out;">
                                </div>

                                <!-- División de Segmentos (Overlay) -->
                                <div
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; pointer-events: none;">
                                    <div style="width: 20%; border-right: 2px solid #ffffff; height: 100%;"></div>
                                    <div style="width: 20%; border-right: 2px solid #ffffff; height: 100%;"></div>
                                    <div style="width: 20%; border-right: 2px solid #ffffff; height: 100%;"></div>
                                    <div style="width: 20%; border-right: 2px solid #ffffff; height: 100%;"></div>
                                    <div style="width: 20%; height: 100%;"></div>
                                </div>

                                <!-- Etiqueta Flotante (Floating Label) -->
                                <div
                                    style="position: absolute; top: -50px; left: {{ porcentaje }}%; transform: translateX(-{{ porcentaje }}%); background-color: #0099cf; color: white; padding: 4px 10px; border-radius: 8px; font-weight: bold; font-size: 13px; white-space: nowrap; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 20; display: flex; flex-direction: column; align-items: center; line-height: 1.2;">
                                    <span>{{ total }} m³</span>
                                    {% if current_tariff %}
                                    <span style="font-size: 10px; opacity: 0.9; font-weight: normal;">
                                        Tarifa: ${{ current_tariff.get('total_tarifa', '0') }}
                                    </span>
                                    {% endif %}
                                    <!-- Flechita -->
                                    <div
                                        style="position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #0099cf transparent transparent transparent;">
                                    </div>
                                </div>
                            </div>

                            <!-- Rótulos Inferiores (Escala) -->
                            <div class="flex justify-between mt-2 text-[10px] font-bold text-base-content/30 w-full"
                                style="padding-top: 5px;">
                                <span style="width: 10%; text-align: left;">0</span>
                                <span style="width: 20%; text-align: center; margin-left: -10%;">20</span>
                                <span style="width: 20%; text-align: center; margin-left: -10%;">40</span>
                                <span style="width: 20%; text-align: center; margin-left: -10%;">60</span>
                                <span style="width: 20%; text-align: center; margin-left: -10%;">80</span>
                                <span style="width: 10%; text-align: right;">100+</span>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros de Consumo -->
        <div class="card bg-base-100 border border-base-content/10 shadow-sm mb-6">
            <div class="card-body p-6">
                <form method="GET"
                    action="{{ url_for('detalle_directorio', tipo=tipo, id_val=item.get('folio') or item.get('id_cliente')) }}"
                    class="space-y-6 w-full">
                    <input type="hidden" name="tab" value="consumos">

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Mes -->
                        <div class="form-control space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Mes</label>
                            <select name="q_mes" class="select select-bordered w-full h-10 min-h-0 px-3">
                                <option value="">Todos los meses</option>
                                {% set meses_es = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio',
                                'Agosto',
                                'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'] %}
                                {% for m in range(1, 13) %}
                                <option value="{{ m }}" {% if q_mes|int==m %}selected{% endif %}>{{ meses_es[m-1] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Año -->
                        <div class="form-control space-y-2">
                            <label
                                class="label font-bold text-xs uppercase text-base-content/60 tracking-widest">Año</label>
                            <select name="q_anio" class="select select-bordered w-full h-10 min-h-0 px-3">
                                <option value="">Todos los años</option>
                                {% for y in range(2024, 2031) %}
                                <option value="{{ y }}" {% if q_anio|int==y %}selected{% endif %}>{{ y }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button type="submit" class="btn btn-primary h-10 min-h-0 px-6 flex items-center gap-2">
                            <span class="icon-[tabler--search] size-5"></span>
                            <span>Buscar</span>
                        </button>
                        <a href="{{ url_for('detalle_directorio', tipo=tipo, id_val=item.get('folio') or item.get('id_cliente')) }}"
                            class="btn btn-soft btn-secondary h-10 min-h-0 btn-square" title="Limpiar">
                            <span class="icon-[tabler--filter-x] size-5"></span>
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
            <div class="card-body p-0">
                <table class="table table-lg">
                    <thead class="bg-base-200/30">
                        <tr>
                            <th>Folio</th>
                            <th>Lectura</th>
                            <th>Consumo (m³)</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-base-content/5">
                        {% for d in consumos %}
                        <tr class="hover:bg-base-200/30">
                            <td><span class="font-bold text-primary">{{ d.folio }}</span></td>
                            <td class="text-base-content/60">{{ d.fecha_lectura }}</td>
                            <td><span class="badge badge-outline border-base-content/10 font-black text-base-content">{{
                                    d.consumo }} m³</span></td>
                            <td class="text-right"><a href="{{ url_for('detalle_consumo', folio=d.folio) }}"
                                    class="btn btn-soft btn-secondary btn-sm">Ver</a></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-10 opacity-40">Sin consumos registrados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

</div>

{% block scripts %}
<script>
    function enableEdit() {
        document.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
        const btnSubmit = document.getElementById('btn-submit');
        if (btnSubmit) btnSubmit.classList.remove('hidden');
        const btnEdit = document.getElementById('btn-editar');
        if (btnEdit) btnEdit.classList.add('hidden');
    }

    function showTab(tabName) {
        // Ocultar todos los contenidos
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        // Mostrar contenido seleccionado
        const targetTab = document.getElementById('tab-' + tabName);
        if (targetTab) targetTab.classList.remove('hidden');

        // Actualizar el valor del selector si el cambio vino de otro lado (opcional)
        const selector = document.getElementById('tab-selector');
        if (selector) selector.value = tabName;

        // Actualizar botones de acción (ejemplo: si estamos en Cotizaciones, mostrar botón de Nueva Cotización)
        updateActionButtons(tabName);
    }

    function updateActionButtons(tabName) {
        const container = document.getElementById('tab-actions');
        if (!container) return;

        container.innerHTML = ''; // Limpiar

        if (tabName === 'cotizaciones') {
            const btn = document.createElement('a');
            btn.href = "{{ url_for('nueva_cotizacion') }}";
            btn.className = "btn btn-primary";
            btn.innerHTML = '<span class="icon-[tabler--plus] size-5"></span><span class="hidden sm:inline">Nueva Cotización</span>';
            container.appendChild(btn);
        }
    }

    // Initialization on load
    document.addEventListener('DOMContentLoaded', () => {
        // Check filtering tab override from server (via query param handling in template context)
        // Since we are not passing 'tab' explicitly in render_template context unless we do...
        // Let's rely on URLSearchParams first, then server variable if any.

        const urlParams = new URLSearchParams(window.location.search);
        let activeTab = urlParams.get('tab');
        // Use a data attribute to pass server-side filter state safely
        const filterEl = document.getElementById('filter-status');
        const hasServerFilter = filterEl ? filterEl.dataset.hasFilter === "true" : false;

        if (hasServerFilter && !activeTab) {
            activeTab = 'consumos';
        }

        if (activeTab) {
            showTab(activeTab);
        }
    });
</script>
{% endblock %}
{% endblock %}