{% extends 'base_flyonui.html' %}

{% block title %}{{ 'Nuevo' if is_new else 'Detalle' }} {{ 'Cliente' if tipo == 'clientes' else 'Prospecto' }} - Sistema
Cophi{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
    <div>
        <div class="flex items-center gap-2 mb-1">
            <a href="{{ url_for('ver_directorio', tipo=tipo) }}" class="btn btn-sm btn-ghost btn-circle" title="Volver">
                <span class="icon-[tabler--arrow-left] size-5"></span>
            </a>
            <h1 class="text-3xl font-bold text-base-content">{{ 'Registro de' if is_new else 'Detalle de' }} {{
                'Cliente' if tipo == 'clientes' else 'Prospecto' }}</h1>
        </div>
        <p class="text-base-content/60 font-medium ml-10">
            {% if is_new %}Ingrese los datos para registrar un nuevo registro en el directorio.{% else %}Gestión
            integral del perfil del cliente y documentos relacionados.{% endif %}
        </p>
    </div>
    {% if not is_new %}
    <div class="flex gap-2">
        <button type="button" class="btn btn-primary shadow-sm" onclick="enableEdit()" id="btn-editar">
            <span class="icon-[tabler--edit] size-5"></span>
            Editar Datos
        </button>
    </div>
    {% endif %}
</div>

<!-- Navegación de Pestañas (Sticky) -->
{% if not is_new %}
<div class="sticky top-0 z-20 bg-base-100/80 backdrop-blur-md pb-4 mb-8 border-b border-base-content/10">
    <div class="flex flex-nowrap overflow-x-auto gap-2 py-2 no-scrollbar">
        <button onclick="showTab('general')" id="btn-general" class="btn btn-primary btn-sm md:btn-md rounded-full">
            <span class="icon-[tabler--info-circle] size-4"></span>
            General
        </button>
        <button onclick="showTab('cotizaciones')" id="btn-cotizaciones"
            class="btn btn-ghost btn-sm md:btn-md rounded-full border border-transparent hover:border-base-content/10">
            <span class="icon-[tabler--file-description] size-4"></span>
            Cotizaciones
        </button>
        <button onclick="showTab('ordenes')" id="btn-ordenes"
            class="btn btn-ghost btn-sm md:btn-md rounded-full border border-transparent hover:border-base-content/10">
            <span class="icon-[tabler--clipboard-list] size-4"></span>
            Órdenes
        </button>
        <button onclick="showTab('tarificador')" id="btn-tarificador"
            class="btn btn-ghost btn-sm md:btn-md rounded-full border border-transparent hover:border-base-content/10">
            <span class="icon-[tabler--calculator] size-4"></span>
            Tarificador
        </button>
        <button onclick="showTab('permisos')" id="btn-permisos"
            class="btn btn-ghost btn-sm md:btn-md rounded-full border border-transparent hover:border-base-content/10">
            <span class="icon-[tabler--file-check] size-4"></span>
            Permisos
        </button>
        <button onclick="showTab('consumos')" id="btn-consumos"
            class="btn btn-ghost btn-sm md:btn-md rounded-full border border-transparent hover:border-base-content/10">
            <span class="icon-[tabler--droplet] size-4"></span>
            Consumos
        </button>
    </div>
</div>
{% endif %}

<!-- SECCIONES DE CONTENIDO -->
<div class="space-y-8 pb-20">

    <!-- PESTAÑA 1: INFORMACIÓN GENERAL -->
    <div id="tab-general" class="tab-content transition-all duration-300">
        <form action="{{ url_for('guardar_directorio', tipo=tipo) }}" method="POST">
            {% if not is_new %}
            {% if tipo == 'clientes' %}
            <input type="hidden" name="ID" value="{{ item.get('ID', '') }}">
            {% else %}
            <input type="hidden" name="folio" value="{{ item.get('folio', '') }}">
            {% endif %}
            {% endif %}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Tarjeta Principal: Identificación -->
                <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                    <div class="card-header bg-base-200/50 border-b border-base-content/10 p-5 flex items-center gap-2">
                        <span class="icon-[tabler--id] size-5 text-primary"></span>
                        <h3 class="font-black uppercase tracking-wider text-sm">Identificación y Contacto</h3>
                    </div>
                    <div class="card-body p-6 space-y-4">
                        <div class="form-control">
                            <label class="label font-bold text-xs uppercase tracking-wider text-base-content/60">Nombre
                                Empresa / Negocio</label>
                            <input type="text" name="nombre_empresa" value="{{ item.get('nombre_empresa', '') }}"
                                required class="input input-bordered w-full font-bold" {% if not is_new %}disabled{%
                                endif %} placeholder="Ej. Abarrotes Don Pepe">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label
                                    class="label font-bold text-xs uppercase tracking-wider text-base-content/60">Tipo /
                                    Giro</label>
                                <input type="text" name="tipo_empresa" value="{{ item.get('tipo_empresa', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}
                                    placeholder="Ej. Restaurante, Taller...">
                            </div>
                            <div class="form-control">
                                <label
                                    class="label font-bold text-xs uppercase tracking-wider text-base-content/60">Teléfono</label>
                                <input type="text" name="telefono_empresa"
                                    value="{{ item.get('telefono_empresa', '') }}" class="input input-bordered w-full"
                                    {% if not is_new %}disabled{% endif %} placeholder="Ej. 55 1234 5678">
                            </div>
                        </div>
                        <div class="form-control">
                            <label
                                class="label font-bold text-xs uppercase tracking-wider text-base-content/60">Dirección
                                Completa</label>
                            <textarea name="direccion_empresa" class="textarea textarea-bordered w-full" rows="3" {% if
                                not is_new %}disabled{% endif %}
                                placeholder="Calle, Número, Colonia, Municipio...">{{ item.get('direccion_empresa', '') }}</textarea>
                        </div>
                    </div>
                </div>

                {% if tipo == 'clientes' %}
                <!-- Tarjeta: Datos Fiscales (Solo Clientes) -->
                <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
                    <div class="card-header bg-base-200/50 border-b border-base-content/10 p-5 flex items-center gap-2">
                        <span class="icon-[tabler--receipt-tax] size-5 text-secondary"></span>
                        <h3 class="font-black uppercase tracking-wider text-sm">Datos Fiscales y Contrato</h3>
                    </div>
                    <div class="card-body p-6 space-y-4">
                        <div class="form-control">
                            <label class="label font-bold text-xs uppercase tracking-wider text-base-content/60">Razón
                                Social</label>
                            <input type="text" name="razon_social" value="{{ item.get('razon_social', '') }}"
                                class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label
                                    class="label font-bold text-xs uppercase tracking-wider text-base-content/60">Giro
                                    Licencia</label>
                                <input type="text" name="giro_licencia" value="{{ item.get('giro_licencia', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}>
                            </div>
                            <div class="form-control">
                                <label class="label font-bold text-xs uppercase tracking-wider text-base-content/60">NIS
                                    (Contrato Agua)</label>
                                <input type="text" name="nis" value="{{ item.get('nis', '') }}"
                                    class="input input-bordered w-full font-mono text-secondary" {% if not is_new
                                    %}disabled{% endif %}>
                            </div>
                            <div class="form-control">
                                <label class="label font-bold text-xs uppercase tracking-wider text-base-content/60">No.
                                    Permiso Descargas</label>
                                <input type="text" name="no_permiso_descargas"
                                    value="{{ item.get('no_permiso_descargas', '') }}"
                                    class="input input-bordered w-full" {% if not is_new %}disabled{% endif %}>
                            </div>
                            <div class="form-control">
                                <label
                                    class="label font-bold text-xs uppercase tracking-wider text-base-content/60">Vigencia
                                    Permiso</label>
                                <input type="text" name="vegencia_permiso_descargas"
                                    value="{{ item.get('vegencia_permiso_descargas', '') }}"
                                    class="input input-bordered w-full" placeholder="dd/mm/aaaa" {% if not is_new
                                    %}disabled{% endif %}>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta: Servicios e Infraestructura (Solo Clientes) -->
                <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden lg:col-span-2">
                    <div class="card-header bg-base-200/50 border-b border-base-content/10 p-5 flex items-center gap-2">
                        <span class="icon-[tabler--tool] size-5 text-info"></span>
                        <h3 class="font-black uppercase tracking-wider text-sm">Infraestructura Hidráulica y Servicios
                        </h3>
                    </div>
                    <div class="card-body p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            <!-- Almacenamiento -->
                            <div class="space-y-4">
                                <h4
                                    class="text-xs font-black uppercase text-base-content/40 border-b border-base-content/5 pb-2">
                                    Almacenamiento</h4>
                                <div class="form-control">
                                    <label class="label text-[10px] uppercase font-bold text-base-content/60">Cisternas
                                        (No. / Cap.)</label>
                                    <div class="join w-full">
                                        <input type="text" name="total_cisternas"
                                            value="{{ item.get('total_cisternas', '') }}"
                                            class="input input-bordered join-item w-1/3" placeholder="No." {% if not
                                            is_new %}disabled{% endif %}>
                                        <input type="text" name="cap_cisternas"
                                            value="{{ item.get('cap_cisternas', '') }}"
                                            class="input input-bordered join-item w-2/3" placeholder="Liters" {% if not
                                            is_new %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="form-control">
                                    <label class="label text-[10px] uppercase font-bold text-base-content/60">Tinacos
                                        (No. / Cap.)</label>
                                    <div class="join w-full">
                                        <input type="text" name="total_tinacos"
                                            value="{{ item.get('total_tinacos', '') }}"
                                            class="input input-bordered join-item w-1/3" placeholder="No." {% if not
                                            is_new %}disabled{% endif %}>
                                        <input type="text" name="cap_tinacos" value="{{ item.get('cap_tinacos', '') }}"
                                            class="input input-bordered join-item w-2/3" placeholder="Liters" {% if not
                                            is_new %}disabled{% endif %}>
                                    </div>
                                </div>
                            </div>

                            <!-- Abastecimiento -->
                            <div class="space-y-4">
                                <h4
                                    class="text-xs font-black uppercase text-base-content/40 border-b border-base-content/5 pb-2">
                                    Abastecimiento</h4>
                                <div class="form-control">
                                    <label class="label text-[10px] uppercase font-bold text-base-content/60">Pozo
                                        (Si-No / No. Conc)</label>
                                    <div class="join w-full">
                                        <input type="text" name="pozo" value="{{ item.get('pozo', '') }}"
                                            class="input input-bordered join-item w-1/3" placeholder="S/N" {% if not
                                            is_new %}disabled{% endif %}>
                                        <input type="text" name="num_concesion_pozo"
                                            value="{{ item.get('num_concesion_pozo', '') }}"
                                            class="input input-bordered join-item w-2/3" placeholder="Concesión" {% if
                                            not is_new %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="form-control">
                                    <label class="label text-[10px] uppercase font-bold text-base-content/60">Tomas /
                                        Red (No. / Red)</label>
                                    <div class="join w-full">
                                        <input type="text" name="num_tomas" value="{{ item.get('num_tomas', '') }}"
                                            class="input input-bordered join-item w-1/3" placeholder="No." {% if not
                                            is_new %}disabled{% endif %}>
                                        <input type="text" name="red" value="{{ item.get('red', '') }}"
                                            class="input input-bordered join-item w-2/3" placeholder="Municipal?" {% if
                                            not is_new %}disabled{% endif %}>
                                    </div>
                                </div>
                            </div>

                            <!-- Pipas y Medidor -->
                            <div class="space-y-4">
                                <h4
                                    class="text-xs font-black uppercase text-base-content/40 border-b border-base-content/5 pb-2">
                                    Pipas y Medidor</h4>
                                <div class="form-control">
                                    <label class="label text-[10px] uppercase font-bold text-base-content/60">Pipas
                                        (Prom. / Cap.)</label>
                                    <div class="join w-full">
                                        <input type="text" name="prom_pipas_mes"
                                            value="{{ item.get('prom_pipas_mes', '') }}"
                                            class="input input-bordered join-item w-1/2" placeholder="Mes" {% if not
                                            is_new %}disabled{% endif %}>
                                        <input type="text" name="capacidad_pipas"
                                            value="{{ item.get('capacidad_pipas', '') }}"
                                            class="input input-bordered join-item w-1/2" placeholder="Cap." {% if not
                                            is_new %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="form-control">
                                    <label class="label text-[10px] uppercase font-bold text-base-content/60">Medidor
                                        (S-N / Serie)</label>
                                    <div class="join w-full">
                                        <input type="text" name="medidor_agua "
                                            value="{{ item.get('medidor_agua ', '') }}"
                                            class="input input-bordered join-item w-1/3" placeholder="S/N" {% if not
                                            is_new %}disabled{% endif %}>
                                        <input type="text" name="no_serie_medidor"
                                            value="{{ item.get('no_serie_medidor', '') }}"
                                            class="input input-bordered join-item w-2/3" placeholder="Serie" {% if not
                                            is_new %}disabled{% endif %}>
                                    </div>
                                </div>
                            </div>

                            <!-- Descargas -->
                            <div class="space-y-4">
                                <h4
                                    class="text-xs font-black uppercase text-base-content/40 border-b border-base-content/5 pb-2">
                                    Descargas</h4>
                                <div class="form-control">
                                    <label class="label text-[10px] uppercase font-bold text-base-content/60">Registro
                                        (S-N / Loc.)</label>
                                    <div class="join w-full">
                                        <input type="text" name="tiene_registro"
                                            value="{{ item.get('tiene_registro', '') }}"
                                            class="input input-bordered join-item w-1/3" placeholder="S/N" {% if not
                                            is_new %}disabled{% endif %}>
                                        <input type="text" name="localización_registro"
                                            value="{{ item.get('localización_registro', '') }}"
                                            class="input input-bordered join-item w-2/3" placeholder="Ubicación" {% if
                                            not is_new %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="form-control">
                                    <label class="label text-[10px] uppercase font-bold text-base-content/60">Trampas
                                        (No. / Cap.)</label>
                                    <div class="join w-full">
                                        <input type="text" name="no_trampas_grasa"
                                            value="{{ item.get('no_trampas_grasa', '') }}"
                                            class="input input-bordered join-item w-1/3" placeholder="No." {% if not
                                            is_new %}disabled{% endif %}>
                                        <input type="text" name="cap_trampas" value="{{ item.get('cap_trampas', '') }}"
                                            class="input input-bordered join-item w-2/3" placeholder="Cap." {% if not
                                            is_new %}disabled{% endif %}>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="mt-8 flex justify-end gap-3 pb-10">
                <a href="{{ url_for('ver_directorio', tipo=tipo) }}" class="btn btn-ghost">Cancelar</a>
                <button type="submit" class="btn btn-primary btn-wide shadow-lg {% if not is_new %}hidden{% endif %}"
                    id="btn-submit">
                    <span class="icon-[tabler--device-floppy] size-5"></span>
                    {{ 'Guardar Registro' if is_new else 'Guardar Cambios' }}
                </button>
            </div>
        </form>
    </div>

    {% if not is_new %}
    <!-- PESTAÑA 2: COTIZACIONES -->
    <div id="tab-cotizaciones" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">
        <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
            <div
                class="card-header bg-base-200/50 border-b border-base-content/10 p-5 font-bold flex justify-between items-center">
                <span>Historial de Cotizaciones</span>
                <a href="{{ url_for('nueva_cotizacion') }}" class="btn btn-xs btn-primary">+ Nueva</a>
            </div>
            <div class="card-body p-0">
                <div class="overflow-x-auto">
                    <table class="table table-lg">
                        <thead class="bg-base-200/30">
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th class="text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-base-content/5">
                            {% for data in cotizaciones %}
                            <tr class="hover:bg-base-200/30">
                                <td><span class="font-bold text-primary">{{ data.folio_cot }}</span></td>
                                <td class="text-base-content/60">{{ data.fecha_cot }}</td>
                                <td class="font-black text-base-content">${{ data.total }}</td>
                                <td class="text-right">
                                    <a href="{{ url_for('detalle_cotizacion', folio=data.folio_cot) }}"
                                        class="btn btn-soft btn-secondary btn-sm">Ver</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-10 opacity-40">Sin cotizaciones registradas.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 3: ORDENES -->
    <div id="tab-ordenes" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Desazolves -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm">
                <div class="card-header bg-base-200/50 border-b border-base-content/10 p-4 font-bold">Desazolves</div>
                <div class="card-body p-0 max-h-96 overflow-y-auto">
                    <table class="table table-sm">
                        <tbody class="divide-y divide-base-content/5">
                            {% for o in ordenes_des|reverse %}
                            <tr class="hover:bg-base-200/30">
                                <td>
                                    <div class="font-bold text-primary">{{ o.folio_des }}</div>
                                    <div class="text-[10px] opacity-60">{{ o.fecha_des }}</div>
                                </td>
                                <td class="text-right"><a
                                        href="{{ url_for('detalle_orden', tipo='desazolve', folio=o.folio_des) }}"
                                        class="btn btn-link btn-xs">Ver</a></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td class="text-center py-4 opacity-40">Vacío</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Trampas -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm">
                <div class="card-header bg-base-200/50 border-b border-base-content/10 p-4 font-bold">Trampas Grasa
                </div>
                <div class="card-body p-0 max-h-96 overflow-y-auto">
                    <table class="table table-sm">
                        <tbody class="divide-y divide-base-content/5">
                            {% for o in ordenes_trampa|reverse %}
                            <tr class="hover:bg-base-200/30">
                                <td>
                                    <div class="font-bold text-primary">{{ o.folio_lt }}</div>
                                    <div class="text-[10px] opacity-60">{{ o.fecha_lt }}</div>
                                </td>
                                <td class="text-right"><a
                                        href="{{ url_for('detalle_orden', tipo='trampa', folio=o.folio_lt) }}"
                                        class="btn btn-link btn-xs">Ver</a></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td class="text-center py-4 opacity-40">Vacío</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Visitas -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm">
                <div class="card-header bg-base-200/50 border-b border-base-content/10 p-4 font-bold">Visitas Técnicas
                </div>
                <div class="card-body p-0 max-h-96 overflow-y-auto">
                    <table class="table table-sm">
                        <tbody class="divide-y divide-base-content/5">
                            {% for o in ordenes_visita|reverse %}
                            <tr class="hover:bg-base-200/30">
                                <td>
                                    <div class="font-bold text-primary">{{ o.folio_vt }}</div>
                                    <div class="text-[10px] opacity-60">{{ o.fecha_vt }}</div>
                                </td>
                                <td class="text-right"><a
                                        href="{{ url_for('detalle_orden', tipo='visita', folio=o.folio_vt) }}"
                                        class="btn btn-link btn-xs">Ver</a></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td class="text-center py-4 opacity-40">Vacío</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 4: TARIFICADOR -->
    <div id="tab-tarificador" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">
        <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
            <div class="card-body p-0">
                <table class="table table-lg">
                    <thead class="bg-base-200/30">
                        <tr>
                            <th>Folio</th>
                            <th>Fecha</th>
                            <th>Precio m3</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-base-content/5">
                        {% for d in tarificadores %}
                        <tr class="hover:bg-base-200/30">
                            <td><span class="font-bold text-primary">{{ d.folio_tar }}</span></td>
                            <td class="text-base-content/60">{{ d.fecha_tar }}</td>
                            <td class="font-black text-success">${{ d.precio_m3_total }}</td>
                            <td class="text-right"><a href="{{ url_for('detalle_tarificador', folio=d.folio_tar) }}"
                                    class="btn btn-soft btn-secondary btn-sm">Ver</a></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-10 opacity-40">Sin reportes aún.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 5: PERMISOS -->
    <div id="tab-permisos" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">
        <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
            <div class="card-body p-0">
                <table class="table table-lg">
                    <thead class="bg-base-200/30">
                        <tr>
                            <th>NIS</th>
                            <th>Interesado</th>
                            <th>Fecha</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-base-content/5">
                        {% for p in permisos %}
                        <tr class="hover:bg-base-200/30">
                            <td><span class="font-mono font-bold text-secondary">{{ p.nis }}</span></td>
                            <td>
                                <div class="font-medium">{{ p.arr_nombre or p.prop_nombre }}</div>
                            </td>
                            <td class="text-base-content/60">{{ p.fecha_acuse }}</td>
                            <td class="text-right"><a href="{{ url_for('detalle_permiso_descarga', nis=p.nis) }}"
                                    class="btn btn-soft btn-secondary btn-sm">Ver</a></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-10 opacity-40">No hay permisos de descarga.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PESTAÑA 6: CONSUMOS -->
    <div id="tab-consumos" class="tab-content hidden animate-in fade-in slide-in-from-bottom-5">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Tarifas -->
            <div class="card bg-base-100 border border-base-content/10 shadow-sm">
                <div class="card-body p-6">
                    <h4
                        class="text-xs font-black uppercase tracking-widest text-primary mb-4 border-b border-primary/10 pb-2">
                        Tarifa Actual (Mensual)</h4>
                    {% if current_tariff %}
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm"><span>Agua:</span><span class="font-bold">${{
                                current_tariff.tarifa_agua }}</span></div>
                        <div class="flex justify-between text-sm"><span>Drenaje:</span><span class="font-bold">${{
                                current_tariff.tarifa_drenaje }}</span></div>
                        <div class="flex justify-between text-sm"><span>Saneamiento:</span><span class="font-bold">${{
                                current_tariff.tarifa_saneamiento }}</span></div>
                        <div
                            class="pt-2 border-t border-base-content/5 flex justify-between text-lg font-black text-primary">
                            <span>Total:</span><span>${{ current_tariff.total_tarifa }}</span></div>
                    </div>
                    {% else %}
                    <div class="text-center py-4 opacity-30 italic text-sm">Sin datos de tarifa.</div>
                    {% endif %}
                </div>
            </div>

            <!-- Nivel Consumo -->
            <div class="lg:col-span-2 card bg-base-100 border border-base-content/10 shadow-sm">
                <div class="card-body p-6 relative">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-xs font-black uppercase tracking-widest text-base-content/40">Monitor de Consumo
                            Mensual ({{ latest_consumo }} m³)</h4>
                        <span
                            class="badge badge-soft {% if latest_consumo > 80 %}badge-error{% elif latest_consumo > 40 %}badge-warning{% else %}badge-success{% endif %} font-black">{{
                            'ALTO' if latest_consumo > 80 else 'MEDIO' if latest_consumo > 40 else 'BAJO' }}</span>
                    </div>

                    <div class="h-4 bg-base-200 rounded-full overflow-hidden flex relative">
                        <div class="h-full bg-success w-[40%]"></div>
                        <div class="h-full bg-warning w-[40%]"></div>
                        <div class="h-full bg-error w-[20%]"></div>
                        <!-- Marker -->
                        {% set pos = latest_consumo if latest_consumo < 100 else 100 %} <div
                            class="absolute h-8 w-1 bg-base-content top-[-8px] shadow-sm transform transition-all duration-1000"
                            style="left: {{ pos }}%;">
                            <div
                                class="absolute top-[-25px] left-1/2 -translate-x-1/2 font-black text-[10px] whitespace-nowrap bg-base-content text-base-100 px-1.5 py-0.5 rounded">
                                {{ latest_consumo }} m³</div>
                    </div>
                </div>

                <div class="flex justify-between mt-2 text-[10px] font-bold text-base-content/30 tracking-tighter">
                    <span>0</span><span>40</span><span>80</span><span>100+</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-base-100 border border-base-content/10 shadow-sm overflow-hidden">
        <div class="card-body p-0">
            <table class="table table-lg">
                <thead class="bg-base-200/30">
                    <tr>
                        <th>Folio</th>
                        <th>Lectura</th>
                        <th>Consumo (m³)</th>
                        <th class="text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-base-content/5">
                    {% for d in consumos %}
                    <tr class="hover:bg-base-200/30">
                        <td><span class="font-bold text-primary">{{ d.folio }}</span></td>
                        <td class="text-base-content/60">{{ d.fecha_lectura }}</td>
                        <td><span class="badge badge-outline border-base-content/10 font-black text-base-content">{{
                                d.consumo }} m³</span></td>
                        <td class="text-right"><a href="{{ url_for('detalle_consumo', folio=d.folio) }}"
                                class="btn btn-soft btn-secondary btn-sm">Ver</a></td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-10 opacity-40">Sin consumos registrados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

</div>

<script>
    function enableEdit() {
        document.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
        const btnSubmit = document.getElementById('btn-submit');
        if (btnSubmit) btnSubmit.classList.remove('hidden');
        const btnEdit = document.getElementById('btn-editar');
        if (btnEdit) btnEdit.classList.add('hidden');
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tabName).classList.remove('hidden');

        document.querySelectorAll('button[id^="btn-"]').forEach(btn => {
            if (btn.id !== 'btn-submit' && btn.id !== 'btn-editar') {
                btn.classList.remove('btn-primary', 'shadow-md');
                btn.classList.add('btn-ghost');
            }
        });

        const activeBtn = document.getElementById('btn-' + tabName);
        if (activeBtn) {
            activeBtn.classList.remove('btn-ghost');
            activeBtn.classList.add('btn-primary', 'shadow-md');
        }

        // Horizontal scroll to button on mobile
        activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
</script>
{% endblock %}